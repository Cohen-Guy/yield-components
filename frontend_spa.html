<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <title>×“×©×‘×•×¨×“ ××¨×›×™×‘×™ ×ª×©×•××”</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      --bg-main: #050816;
      --bg-panel: #101528;
      --bg-panel-soft: #151a32;
      --bg-sidebar: #050a18;
      --accent: #5dd0ff;
      --accent-soft: rgba(93,208,255,0.14);
      --accent-strong: #3ab4ff;
      --text-main: #e9eefb;
      --text-muted: #a6b2c9;
      --border-subtle: rgba(255,255,255,0.06);
      --danger: #ff7676;
      --success: #7ce38b;
      --warning: #ffc773;
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      min-height: 100vh;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #1a2344 0, #050816 55%, #02030a 100%);
      color: var(--text-main);
      display: flex;
      align-items: stretch;
      justify-content: center;
    }

    .app-shell {
      width: 100%;
      max-width: 1440px;
      min-height: 100vh;
      display: grid;
      grid-template-columns: 220px 1fr;
      background: linear-gradient(135deg, rgba(255,255,255,0.03), rgba(3,5,20,0.98));
      border-left: 1px solid rgba(255,255,255,0.05);
      border-right: 1px solid rgba(255,255,255,0.05);
    }

    /* Sidebar */
    .sidebar {
      background: radial-gradient(circle at top, #141b3d 0, #050a18 58%);
      border-right: 1px solid rgba(255,255,255,0.08);
      padding: 18px 14px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    .sidebar-logo { display: flex; align-items: center; gap: 8px; padding: 6px 4px 12px; border-bottom: 1px solid rgba(255,255,255,0.07); }
    .sidebar-logo-icon {
      width: 32px; height: 32px; border-radius: 10px;
      background: radial-gradient(circle at 30% 20%, #5dd0ff, #4a63ff);
      display: flex; align-items: center; justify-content: center; font-size: 1.1rem;
    }
    .sidebar-logo-text { display: flex; flex-direction: column; gap: 2px; }
    .sidebar-logo-title { font-size: 0.95rem; font-weight: 600; letter-spacing: 0.03em; }
    .sidebar-logo-sub { font-size: 0.7rem; color: var(--text-muted); }

    .sidebar-nav { display: flex; flex-direction: column; gap: 4px; margin-top: 6px; }
    .nav-item {
      border-radius: 999px; padding: 7px 10px; font-size: 0.86rem;
      display: flex; align-items: center; gap: 8px; color: var(--text-muted);
      cursor: pointer; border: 1px solid transparent;
      transition: background 0.15s, transform 0.08s, border-color 0.15s, color 0.15s;
    }
    .nav-item span.icon { font-size: 1rem; width: 18px; text-align: center; }
    .nav-item:hover { background: rgba(93,208,255,0.08); color: var(--text-main); border-color: rgba(93,208,255,0.4); transform: translateY(-1px); }
    .nav-item.active { background: linear-gradient(120deg, rgba(93,208,255,0.25), rgba(116,127,255,0.25)); color: #f8fbff; border-color: rgba(93,208,255,0.6); }

    .sidebar-meta {
      margin-top: auto; padding-top: 8px; border-top: 1px dashed rgba(255,255,255,0.12);
      font-size: 0.7rem; color: var(--text-muted); display: flex; flex-direction: column; gap: 4px;
    }
    .sidebar-meta span { display: flex; justify-content: space-between; }

    /* Main area */
    .main { padding: 16px 18px 18px; display: flex; flex-direction: column; gap: 12px; }

    .main-header { display: flex; align-items: center; justify-content: space-between; gap: 10px; padding: 6px 6px 8px; }
    .main-title-block { display: flex; flex-direction: column; gap: 2px; }
    .main-title { font-size: 1.4rem; letter-spacing: 0.02em; display: flex; align-items: center; gap: 6px; }
    .main-subtitle { font-size: 0.82rem; color: var(--text-muted); }

    .badge-file {
      font-size: 0.75rem; padding: 3px 8px; border-radius: 999px;
      background: rgba(0,0,0,0.35); border: 1px solid rgba(255,255,255,0.16); color: var(--text-muted);
    }

    .main-header-actions { display: flex; align-items: center; gap: 8px; }
    .btn-ghost {
      border-radius: 999px; border: 1px solid rgba(255,255,255,0.18);
      background: rgba(5,8,25,0.9); color: var(--text-main);
      padding: 6px 10px; font-size: 0.8rem; display: flex; align-items: center; gap: 6px;
      cursor: pointer; transition: background 0.15s, transform 0.08s, box-shadow 0.15s;
    }
    .btn-ghost:hover { background: rgba(18,25,60,0.95); box-shadow: 0 4px 12px rgba(0,0,0,0.4); transform: translateY(-1px); }

    /* Filters bar */
    .filters-bar {
      background: radial-gradient(circle at left, rgba(93,208,255,0.15), rgba(10,15,45,0.98));
      border-radius: 14px; padding: 10px 12px; border: 1px solid rgba(93,208,255,0.35);
      display: flex; flex-wrap: wrap; gap: 10px; align-items: flex-end;
      box-shadow: 0 12px 28px rgba(0,0,0,0.55);
    }
    .field { display: flex; flex-direction: column; gap: 3px; min-width: 140px; }
    .field label { font-size: 0.78rem; color: var(--text-muted); }
    select {
      background: #050816; border-radius: 10px; border: 1px solid rgba(255,255,255,0.25);
      color: var(--text-main); font-size: 0.8rem; padding: 5px 9px; outline: none; min-height: 30px;
    }
    select:focus { border-color: var(--accent); box-shadow: 0 0 0 1px rgba(93,208,255,0.5); }

    /* Panels / cards */
    .panels-row { display: grid; grid-template-columns: 2fr 1.8fr; gap: 10px; margin-top: 8px; margin-bottom: 10px; }
    .panel {
      background: linear-gradient(135deg, rgba(14,18,40,0.98), rgba(10,12,30,0.98));
      border-radius: 14px; padding: 10px 12px; border: 1px solid var(--border-subtle);
      box-shadow: 0 14px 32px rgba(0,0,0,0.5); display: flex; flex-direction: column; gap: 6px; min-height: 220px;
    }
    .panel-header { display: flex; align-items: center; justify-content: space-between; font-size: 0.9rem; margin-bottom: 2px; }
    .panel-header-title { display: flex; align-items: center; gap: 6px; }
    .panel-header-title span.icon { font-size: 1.1rem; }
    .panel-header-sub { font-size: 0.75rem; color: var(--text-muted); }

    .kpi-row { display: grid; grid-template-columns: repeat(4, minmax(0, 1fr)); gap: 8px; margin-top: 4px; }
    .kpi-card {
      background: radial-gradient(circle at top, rgba(93,208,255,0.2), rgba(10,15,40,0.95));
      border-radius: 12px; padding: 7px 9px; border: 1px solid rgba(93,208,255,0.4);
      display: flex; flex-direction: column; gap: 2px; font-size: 0.8rem;
    }
    .kpi-label { color: var(--text-muted); font-size: 0.75rem; }
    .kpi-value { font-size: 1rem; font-weight: 600; }
    .kpi-badge { font-size: 0.7rem; color: var(--accent); }

    .views-wrapper { margin-top: 4px; display: flex; flex-direction: column; gap: 10px; }
    .view { display: none; }
    .view.active { display: block; animation: fadeIn 0.22s ease-out; }

    /* Matrix Table */
    .table-meta {
      margin: 6px 0 6px;
      font-size: 0.78rem;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }
    .years-badges { display: inline-flex; gap: 6px; flex-wrap: wrap; }
    .year-chip {
      padding: 2px 8px; border-radius: 999px; border: 1px solid rgba(255,255,255,0.18);
      background: rgba(0,0,0,0.25); color: var(--text-main); font-size: 0.75rem;
    }

    .table-wrapper {
      flex: 1; overflow: auto; border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.06);
      background: radial-gradient(circle at top left, rgba(93,208,255,0.12), rgba(5,7,20,0.96));
    }
    table { width: max-content; min-width: 100%; border-collapse: collapse; font-size: 0.78rem; }
    th, td { padding: 6px 6px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.05); white-space: nowrap; }
    th {
      background: linear-gradient(90deg, rgba(83,211,255,0.25), rgba(140,120,255,0.22));
      font-weight: 600; position: sticky; top: 0; z-index: 2;
    }
    .th-group { position: sticky; top: 0; z-index: 3; font-weight: 700; }
    tr:nth-child(even) { background: rgba(255,255,255,0.015); }
    tr:hover { background: rgba(83,211,255,0.09); }

    .table-footer {
      margin-top: 6px;
      font-size: 0.8rem;
      color: var(--text-main);
      background: linear-gradient(90deg, rgba(93,208,255,0.12), rgba(140,120,255,0.12));
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 10px;
      padding: 8px 10px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }
    .table-footer .meta { color: var(--text-muted); font-size: 0.76rem; }

    /* Chart panel */
    .chart-block { margin-top: 8px; }
    .chart-title {
      margin: 6px 0 4px;
      font-size: 0.9rem;
      color: var(--text-main);
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .chart-container { position: relative; width: 100%; height: 260px; }

    .status-text { font-size: 0.75rem; color: var(--text-muted); }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(4px); } to { opacity: 1; transform: translateY(0); } }

    @media (max-width: 1040px) {
      .app-shell { grid-template-columns: 64px 1fr; }
      .sidebar-logo-text { display: none; }
      .sidebar-nav span.label { display: none; }
      .nav-item { justify-content: center; }
    }
    @media (max-width: 840px) {
      .app-shell { grid-template-columns: 1fr; }
      .sidebar { display: none; }
      .main { padding: 12px; }
      .panels-row { grid-template-columns: 1fr; }
      .kpi-row { grid-template-columns: repeat(2, minmax(0, 1fr)); }
      .table-footer { flex-direction: column; align-items: flex-start; }
      .chart-container { height: 240px; }
    }
  </style>
</head>

<body>
<div class="app-shell">
  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="sidebar-logo">
      <div class="sidebar-logo-icon">â§‰</div>
      <div class="sidebar-logo-text">
        <div class="sidebar-logo-title">××¨×›×™×‘×™ ×ª×©×•××”</div>
        <div class="sidebar-logo-sub">Dashboard v3.1 â€¢ Matrix</div>
      </div>
    </div>

    <div class="sidebar-nav">
      <div class="nav-item active" data-view="tracks">
        <span class="icon">ğŸ“‹</span><span class="label">××¡×œ×•×œ×™× ×•×—×‘×¨×•×ª</span>
      </div>
      <div class="nav-item" data-view="charts">
        <span class="icon">ğŸ“ˆ</span><span class="label">×’×¨×¤×™×</span>
      </div>
    </div>

    <div class="sidebar-meta" id="sidebar_meta">
      <span><span>×—×‘×¨×•×ª:</span><span>-</span></span>
      <span><span>××¡×œ×•×œ×™×:</span><span>-</span></span>
      <span><span>×©× ×™×:</span><span>-</span></span>
      <span><span>×¡×”×´×› ×¨×©×•××•×ª:</span><span>-</span></span>
    </div>
  </aside>

  <!-- MAIN -->
  <main class="main">
    <!-- HEADER -->
    <header class="main-header">
      <div class="main-title-block">
        <div class="main-title"><span>×“×©×‘×•×¨×“ ××¨×›×™×‘×™ ×ª×©×•××”</span></div>
        <div class="main-subtitle">
          ×˜×‘×œ×ª ××˜×¨×™×¦×” 1:1 ×›××• ×‘-PowerPivot: â€œ×›×œ ×”×ª×§×•×¤×”â€ + ×§×‘×•×¦×•×ª ×©× ×™× (×“×™×¨×•×’ ××—×–×§×”/×“×™×¨×•×’ ×ª×©×•××”/×©×™×¢×•×¨/×ª×©×•××”).
        </div>
      </div>
      <div class="main-header-actions">
        <div class="badge-file" id="badge_file">×§×•×‘×¥: -</div>
        <button class="btn-ghost" type="button" id="btn_reload">â†» ×¨×¢× ×•×Ÿ × ×ª×•× ×™×</button>
      </div>
    </header>

    <!-- FILTERS -->
    <section class="filters-bar">
      <!-- ×—×‘×¨×” -->
      <div class="field">
        <label>×—×‘×¨×”</label>
        <select id="f_company"></select>
      </div>

      <!-- ×¡×“×¨: ×¡×•×’ ×—×™×¡×›×•×Ÿ â†’ ×¡×•×’ ×§×•×¤×” â†’ ××¡×œ×•×œ â†’ ×¡×—×™×¨×•×ª â†’ ××¤×™×§ â†’ ×©× ×” -->
      <div class="field">
        <label>×¡×•×’ ×—×™×¡×›×•×Ÿ</label>
        <select id="f_saving_type"></select>
      </div>

      <div class="field">
        <label>×¡×•×’ ×§×•×¤×”</label>
        <select id="f_fund_type"></select>
      </div>

      <div class="field">
        <label>××¡×œ×•×œ</label>
        <select id="f_track"></select>
      </div>

      <div class="field">
        <label>×¡×—×™×¨×•×ª</label>
        <select id="f_liquidity"></select>
      </div>

      <div class="field">
        <label>××¤×™×§ ×”×©×§×¢×”</label>
        <select id="f_category" multiple></select>
      </div>

      <div class="field">
        <label>×©× ×ª ×“×™×•×•×—</label>
        <select id="f_year" multiple></select>
      </div>
    </section>

    <!-- KPIs -->
    <section class="panels-row">
      <div class="panel">
        <div class="panel-header">
          <div class="panel-header-title"><span class="icon">ğŸ“Š</span><span>××“×“×™ ××¤×ª×— â€“ ×¡×™×›×•×</span></div>
        </div>
        <div class="kpi-row" id="kpi_row"></div>
      </div>

      <div class="panel">
        <div class="panel-header">
          <div class="panel-header-title"><span class="icon">â„¹ï¸</span><span>×¡×˜×˜×•×¡ ×¤×™×œ×˜×¨×™×</span></div>
        </div>
        <div class="status-text" id="status_filters">×˜×•×¢×Ÿ × ×ª×•× ×™×...</div>
      </div>
    </section>

    <!-- VIEWS -->
    <section class="views-wrapper">
      <!-- Overview -->
      <section class="view" id="view_overview">
        <div class="panel">
          <div class="panel-header">
            <div class="panel-header-title"><span class="icon">ğŸ“Œ</span><span>×˜×‘×œ×ª ×¡×™×›×•× ×œ×¤×™ ××¡×œ×•×œ</span></div>
            <div class="panel-header-sub">××•×ª×• ××‘× ×”: ×›×œ ×”×ª×§×•×¤×” + 2022/2023/2024 â†’ ×“×™×¨×•×’ ××—×–×§×”/×“×™×¨×•×’ ×ª×©×•××”/×©×™×¢×•×¨/×ª×©×•××”</div>
          </div>

          <div class="table-meta">
            <span>×©× ×™× ×‘×ª×¦×•×’×”:</span>
            <div class="years-badges" id="overview_years">â€”</div>
          </div>

          <div class="table-wrapper" id="table_overview_wrapper">×˜×•×¢×Ÿ...</div>
        </div>
      </section>

      <!-- Tracks -->
      <section class="view active" id="view_tracks">
        <div class="panel">
          <div class="panel-header">
            <div class="panel-header-title"><span class="icon">ğŸ“‹</span><span>×˜×‘×œ×ª ×¡×™×›×•× ×œ×¤×™ ××¡×œ×•×œ</span></div>
            <div class="panel-header-sub">××•×ª×” ×”×™×¨×¨×›×™×” ×‘×“×™×•×§, ××¤×•×¨×§×ª ×œ××¡×œ×•×œ×™×</div>
          </div>

          <div class="table-meta">
            <span>×©× ×™× ×‘×ª×¦×•×’×”:</span>
            <div class="years-badges" id="tracks_years">â€”</div>
          </div>

          <div class="table-wrapper" id="table_tracks_wrapper">×˜×•×¢×Ÿ...</div>
        </div>
      </section>

      <!-- Charts -->
      <section class="view" id="view_charts">
        <div class="panel">
          <div class="panel-header">
            <div class="panel-header-title"><span class="icon">ğŸ“ˆ</span><span>×’×¨×¤×™× ×¨×‘×¢×•× ×™×™×</span></div>
            <div class="panel-header-sub">×¦×™×¨ X: ×©× ×”+×¨×‘×¢×•×Ÿ â€¢ ×¦×™×¨ Y: ××—×•×–×™×</div>
          </div>

          <div style="margin-bottom:6px; font-size:0.78rem; color:var(--text-muted);">
            ×˜×™×¤: ×¦××¦× ×¤×™×œ×˜×¨×™× (×—×‘×¨×”/××¡×œ×•×œ/××¤×™×§) ×›×“×™ ×©×”×’×¨×¤×™× ×™×”×™×• ×§×¨×™××™× ×™×•×ª×¨.
          </div>

          <div class="chart-block">
            <div class="chart-title">×ª×©×•××” ×¨×‘×¢×•× ×™×ª (%)</div>
            <div class="chart-container">
              <canvas id="chart_yield"></canvas>
            </div>
          </div>

          <div class="chart-block">
            <div class="chart-title">××—×–×§×” ×¨×‘×¢×•× ×™×ª ×××•×¦×¢×ª ×œ×ª×¦×•×’×” (%)</div>
            <div class="chart-container">
              <canvas id="chart_weight"></canvas>
            </div>
          </div>
        </div>
      </section>
    </section>

  </main>
</div>

<script>
  /* ===========================
     ××¦×‘ ×’×œ×•×‘×œ×™
  ============================ */
  const state = {
    raw: [],
    filtered: [],
    meta: {},
    currentView: "tracks",
    chartYield: null,
    chartWeight: null
  };

  const FILTERS = {
    company:     { id: "f_company",     field: "company_short", sort: "locale" },
    saving_type: { id: "f_saving_type", field: "saving_type",   sort: "locale" },
    fund_type:   { id: "f_fund_type",   field: "fund_type",     sort: "locale" },
    track:       { id: "f_track",       field: "track_name",    sort: "locale" },
    liquidity:   { id: "f_liquidity",   field: "liquidity",     sort: "locale" },
    category:    { id: "f_category",    field: "category",      sort: "locale",  multi: true },
    year:        { id: "f_year",        field: "year",          sort: "numeric", multi: true }
  };

  /* ===========================
     Utilities
  ============================ */
  function setSelectOptions(selectEl, values, { includeAll = true, allLabel = "×”×›×•×œ" } = {}) {
    const frag = document.createDocumentFragment();
    selectEl.innerHTML = "";
    if (includeAll) {
      const optAll = document.createElement("option");
      optAll.value = "";
      optAll.textContent = allLabel;
      frag.appendChild(optAll);
    }
    values.forEach(v => {
      const opt = document.createElement("option");
      opt.value = String(v);
      opt.textContent = String(v);
      frag.appendChild(opt);
    });
    selectEl.appendChild(frag);
  }
  function safeNumber(v) { const x = Number(String(v).replaceAll(",","")); return isNaN(x) ? null : x; }
  function uniqueSortedYears(rows) {
    return Array.from(new Set(
      rows.map(r => r.year).filter(v => v !== null && v !== undefined && Number(v) >= 2022)
    )).sort((a, b) => a - b);
  }
  function getSelectValues(selectEl, multi = false) {
    if (!multi) return selectEl.value || "";
    return Array.from(selectEl.selectedOptions).map(o => o.value).filter(v => v !== "");
  }

  // ====== ××™× ×¤×¨× ×¡ ×™×—×™×“×•×ª ×•×”××¨×” ×œ××—×•×–×™× ======
  // ×§×•×‘×¢ ×× ×¡×“×¨×” "× ×¨××™×ª" ×‘××—×•×–×™× (×¨×•×‘ ×”×¢×¨×›×™× ×‘×™×Ÿ 1.5% ×œ-150%)
  function inferIsPercent(arr, minFrac=0.6) {
    const xs = arr.map(safeNumber).filter(x => x !== null && x > 0);
    if (!xs.length) return false;
    const pctLike = xs.filter(x => x >= 1.5 && x <= 150).length / xs.length;
    return pctLike >= minFrac;
  }
  // ××—×–×™×¨ value ×¢×œ ×¡×§××œ×ª ××—×•×–×™× (0-100): ×× ×”××§×•×¨ ××—×•×–×™× â†’ value, ××—×¨×ª â†’ value*100
  function toPct(value, isPercent) {
    const v = safeNumber(value);
    if (v === null) return null;
    return isPercent ? v : v * 100;
  }

  /* ===========================
     × ×™×•×•×˜
  ============================ */
  function initNav() {
    document.querySelectorAll(".nav-item").forEach(item => {
      item.addEventListener("click", () => setView(item.getAttribute("data-view")));
    });
  }
  function setView(viewName) {
    state.currentView = viewName;
    document.querySelectorAll(".nav-item").forEach(el =>
      el.classList.toggle("active", el.getAttribute("data-view") === viewName)
    );
    document.querySelectorAll(".view").forEach(el =>
      el.classList.toggle("active", el.id.replace("view_", "") === viewName)
    );
    if (viewName === "overview") renderOverviewMatrix();
    else if (viewName === "tracks") renderTracksMatrix();
    else if (viewName === "charts") renderCharts();
  }

  /* ===========================
     ×˜×¢×™× ×ª × ×ª×•× ×™×
  ============================ */
  async function reloadData() {
    const tableOverview = document.getElementById("table_overview_wrapper");
    const tableTracks   = document.getElementById("table_tracks_wrapper");
    const statusFilters = document.getElementById("status_filters");
    tableOverview.textContent = "×˜×•×¢×Ÿ × ×ª×•× ×™×...";
    tableTracks.textContent = "×˜×•×¢×Ÿ × ×ª×•× ×™×...";
    statusFilters.textContent = "×˜×•×¢×Ÿ × ×ª×•× ×™×...";

    try {
      const res = await fetch("/api/data");
      if (!res.ok) throw new Error("×©×’×™××” ×‘×˜×¢×™× ×ª /api/data: " + res.status);
      const data = await res.json();
      state.raw = data.rows || [];
      state.meta = data.meta || {};
      document.getElementById("badge_file").textContent = "×§×•×‘×¥: " + (state.meta.file || "-");
      updateSidebarMeta();
      buildFilters();
      refreshFilterOptions();
      applyFilters();
    } catch (e) {
      console.error(e);
      tableOverview.textContent = "×©×’×™××” ×‘×˜×¢×™× ×ª ×”× ×ª×•× ×™×.";
      tableTracks.textContent = "×©×’×™××” ×‘×˜×¢×™× ×ª ×”× ×ª×•× ×™×.";
      statusFilters.textContent = "×©×’×™××” ×‘×˜×¢×™× ×ª ×”× ×ª×•× ×™×.";
    }
  }
  function updateSidebarMeta() {
    const m = state.meta || {};
    document.getElementById("sidebar_meta").innerHTML = `
      <span><span>×—×‘×¨×•×ª:</span><span>${(m.companies || []).length}</span></span>
      <span><span>××¡×œ×•×œ×™×:</span><span>${(m.tracks || []).length}</span></span>
      <span><span>×©× ×™×:</span><span>${(m.years || []).join(" ,") || "-"}</span></span>
      <span><span>×¡×”×´×› ×¨×©×•××•×ª:</span><span>${m.total_rows || "-"}</span></span>
    `;
  }

  /* ===========================
     ×¤×™×œ×˜×¨×™×
  ============================ */
  function buildFilters() {
    const rows = state.raw || [];
    const companies   = Array.from(new Set(rows.map(r=>r.company_short).filter(Boolean))).sort((a,b)=>a.localeCompare(b,"he"));
    const savingTypes = Array.from(new Set(rows.map(r=>r.saving_type).filter(Boolean))).sort((a,b)=>a.localeCompare(b,"he"));
    const fundTypes   = Array.from(new Set(rows.map(r=>r.fund_type).filter(Boolean))).sort((a,b)=>a.localeCompare(b,"he"));
    const tracks      = Array.from(new Set(rows.map(r=>r.track_name).filter(Boolean))).sort((a,b)=>a.localeCompare(b,"he"));
    const liquidities = Array.from(new Set(rows.map(r=>r.liquidity).filter(Boolean))).sort((a,b)=>a.localeCompare(b,"he"));
    const categories  = Array.from(new Set(rows.map(r=>r.category).filter(Boolean))).sort((a,b)=>a.localeCompare(b,"he"));
    const years       = uniqueSortedYears(rows);

    setSelectOptions(document.getElementById(FILTERS.company.id),     companies);
    setSelectOptions(document.getElementById(FILTERS.saving_type.id), savingTypes);
    setSelectOptions(document.getElementById(FILTERS.fund_type.id),   fundTypes);
    setSelectOptions(document.getElementById(FILTERS.track.id),       tracks);
    setSelectOptions(document.getElementById(FILTERS.liquidity.id),   liquidities);
    setSelectOptions(document.getElementById(FILTERS.category.id),    categories, { includeAll:false });
    setSelectOptions(document.getElementById(FILTERS.year.id),        years,     { includeAll:false });

    Object.values(FILTERS).forEach(({id})=>{
      const sel = document.getElementById(id);
      if (!sel) return;
      if (!sel.multiple) sel.value = "";
      sel.addEventListener("change", onFilterChange);
    });
  }

  function filterRowsByFilters(filters, ignoreKey=null) {
    const rows = state.raw || [];
    return rows.filter(r=>{
      if (ignoreKey!=="company"     && filters.company     && r.company_short !== filters.company) return false;
      if (ignoreKey!=="saving_type" && filters.saving_type && r.saving_type   !== filters.saving_type) return false;
      if (ignoreKey!=="fund_type"   && filters.fund_type   && r.fund_type     !== filters.fund_type)   return false;
      if (ignoreKey!=="track"       && filters.track       && r.track_name    !== filters.track)       return false;
      if (ignoreKey!=="liquidity"   && filters.liquidity   && r.liquidity     !== filters.liquidity)   return false;

      if (ignoreKey!=="category" && Array.isArray(filters.category) && filters.category.length &&
          !filters.category.includes(r.category)) return false;

      if (ignoreKey!=="year" && Array.isArray(filters.year) && filters.year.length &&
          !filters.year.includes(String(r.year))) return false;

      return true;
    });
  }

  function refreshFilterOptions() {
    const filters = getCurrentFilters();
    Object.entries(FILTERS).forEach(([key, meta])=>{
      const sel = document.getElementById(meta.id);
      if (!sel) return;
      const isMulti = !!meta.multi;

      const prevValues = isMulti
        ? Array.from(sel.selectedOptions).map(o=>o.value)
        : [sel.value];

      const rowsForKey = filterRowsByFilters(filters, key);
      let values = Array.from(new Set(
        rowsForKey.map(r=>r[meta.field]).filter(v=>v!==null && v!==undefined && v!=="")
      ));
      if (meta.sort==="numeric") values.sort((a,b)=>Number(a)-Number(b));
      else values.sort((a,b)=>String(a).localeCompare(String(b),"he"));

      setSelectOptions(sel, values, { includeAll: !isMulti });

      if (isMulti) {
        const valuesStr = values.map(String);
        Array.from(sel.options).forEach(o => {
          o.selected = prevValues.map(String).includes(String(o.value)) &&
                      valuesStr.includes(String(o.value));
        });
      } else {
        const pv = prevValues[0] || "";
        sel.value = values.map(String).includes(String(pv)) ? String(pv) : "";
      }
    });
  }

  function getCurrentFilters() {
    return {
      company:     getSelectValues(document.getElementById(FILTERS.company.id),     false),
      saving_type: getSelectValues(document.getElementById(FILTERS.saving_type.id), false),
      fund_type:   getSelectValues(document.getElementById(FILTERS.fund_type.id),   false),
      track:       getSelectValues(document.getElementById(FILTERS.track.id),       false),
      liquidity:   getSelectValues(document.getElementById(FILTERS.liquidity.id),   false),
      category:    getSelectValues(document.getElementById(FILTERS.category.id),    true),
      year:        getSelectValues(document.getElementById(FILTERS.year.id),        true),
    };
  }

  function onFilterChange() { refreshFilterOptions(); applyFilters(); }

  function applyFilters() {
    const f = getCurrentFilters();
    const rows = (state.raw || []).filter(r => r.year == null || Number(r.year) >= 2022);
    state.filtered = rows.filter(r => {
      if (f.company && r.company_short !== f.company) return false;
      if (f.saving_type && r.saving_type !== f.saving_type) return false;
      if (f.fund_type && r.fund_type !== f.fund_type) return false;
      if (f.track && r.track_name !== f.track) return false;
      if (f.liquidity && r.liquidity !== f.liquidity) return false;
      if (Array.isArray(f.category) && f.category.length && !f.category.includes(r.category)) return false;
      if (Array.isArray(f.year) && f.year.length && !f.year.includes(String(r.year))) return false;
      return true;
    });

    updateFiltersStatus();
    renderKPIs();
    renderOverviewMatrix();
    renderTracksMatrix();
    renderCharts();
  }

  function updateFiltersStatus() {
    const f = getCurrentFilters();
    const rowsCount = (state.filtered || []).length;
    const parts = [];
    if (f.company) parts.push("×—×‘×¨×”: " + f.company);
    if (f.saving_type) parts.push("×¡×•×’ ×—×™×¡×›×•×Ÿ: " + f.saving_type);
    if (f.fund_type) parts.push("×¡×•×’ ×§×•×¤×”: " + f.fund_type);
    if (f.track) parts.push("××¡×œ×•×œ: " + f.track);
    if (f.liquidity) parts.push("×¡×—×™×¨×•×ª: " + f.liquidity);
    if (Array.isArray(f.category) && f.category.length) parts.push("××¤×™×§: " + f.category.join(", "));
    if (Array.isArray(f.year) && f.year.length) parts.push("×©× ×™×: " + f.year.join(", "));
    document.getElementById("status_filters").textContent =
      (parts.length ? parts.join(" â€¢ ") : "×œ×œ× ×¡×™× ×•×Ÿ â€“ ××•×¦×’×•×ª ×›×œ ×”×¨×©×•××•×ª") +
      ` â€¢ ×¨×©×•××•×ª ×œ××—×¨ ×¡×™× ×•×Ÿ: ${rowsCount}`;
  }

  /* ===========================
     KPI
  ============================ */
  function renderKPIs() {
    const rows = state.filtered || [];
    const kpiRow = document.getElementById("kpi_row");
    if (!rows.length) {
      kpiRow.innerHTML = `<div class="kpi-card"><div class="kpi-label">××™×Ÿ × ×ª×•× ×™×</div><div class="kpi-value">0</div></div>`;
      return;
    }
    const companies = new Set(rows.map(r=>r.company_short));
    const tracks    = new Set(rows.map(r=>r.track_name));

    kpiRow.innerHTML = `
      <div class="kpi-card">
        <div class="kpi-label">×—×‘×¨×•×ª ×‘×¤×™×œ×˜×¨</div>
        <div class="kpi-value">${companies.size}</div>
        <div class="kpi-badge">××ª×•×š ${state.meta.companies ? state.meta.companies.length : "-"}</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">××¡×œ×•×œ×™× ×‘×¤×™×œ×˜×¨</div>
        <div class="kpi-value">${tracks.size}</div>
        <div class="kpi-badge">×¡×”"×› ×¨×©×•××•×ª: ${(state.filtered || []).length}</div>
      </div>
    `;
  }

  /* ===========================
     ×œ×•×’×™×§×ª ×™×—×™×“×•×ª ×•×—×™×©×•×‘×™× (1:1 ×¢× ×”Ö¾Query)
     - ×ª×¨×•××”_% = ××©×§×œ_% * ×ª×©×•××”_%
     - ×ª×©×•××”_% = ×ª×¨×•××”_% / ××©×§×œ_%
     - ××™×Ÿ × ×¨××•×œ ×©×œ ××©×§×œ×™×
  ============================ */

  // ×§×‘×œ×ª ×“×’×œ×™ ×™×—×™×“×•×ª (×”×× weight/contribution ×”× ×‘××—×•×–×™×) ×¢×‘×•×¨ ×ª×ª-×§×‘×•×¦×”
  function unitFlagsForSubset(subset) {
    const wArr = subset.map(r=>r.weight).filter(v=>v!==null && v!==undefined);
    const cArr = subset.map(r=>r.contribution).filter(v=>v!==null && v!==undefined);
    return {
      wIsPct: inferIsPercent(wArr),
      cIsPct: inferIsPercent(cArr)
    };
  }

  // ××—×–×™×¨ ××•×‘×™×™×§×˜ ×¦×‘×™×¨×” ×œ×¤×™ ×™×©×•×ª ×•×©× ×” (×•××—×©×‘ yield ×¢×œ ×¤×™ ××—×•×–×™×)
  function aggregateByEntityYear(rows, entityKeyFn) {
    const by = {};
    // × ×—×œ×§ ×œ×¤×™ entity + year ×›×“×™ ×œ×”×—×™×œ ×“×’×œ×™ ×™×—×™×“×•×ª ×¢×§×‘×™×™× ×œ×›×œ ×ª×
    const tmp = {};
    rows.forEach(r=>{
      const key = entityKeyFn(r);
      if (!key) return;
      if (r.year===null || r.year===undefined) return;
      const yr = Number(r.year);
      const bucket = key + "||" + yr;
      (tmp[bucket] = tmp[bucket] || []).push(r);
    });

    const flagsCache = {};
    Object.entries(tmp).forEach(([bucket, subset])=>{
      // ×“×’×œ×™ ×™×—×™×“×•×ª ×œ×ª×ª-×”×§×‘×•×¦×”
      const flags = unitFlagsForSubset(subset);
      flagsCache[bucket] = flags;
    });

    // ×¦×‘×™×¨×” ×‘×¤×•×¢×œ (×‘×¡×§×œ×ª ××—×•×–×™×)
    Object.entries(tmp).forEach(([bucket, subset])=>{
      const [key, yrStr] = bucket.split("||");
      const yr = Number(yrStr);
      const { wIsPct, cIsPct } = flagsCache[bucket];

      let wSumPct = 0, cSumPct = 0, n = 0;
      subset.forEach(r=>{
        const wPct = toPct(r.weight,       wIsPct);
        const cPct = toPct(r.contribution, cIsPct);
        if (wPct!==null) wSumPct += wPct;
        if (cPct!==null) cSumPct += cPct;
        n += 1;
      });

      by[key] = by[key] || {};
      by[key][yr] = { wSumPct, cSumPct, n, flags: { wIsPct, cIsPct } };
    });

    return by;
  }

  // ××©×§×œ ×œ×ª×¦×•×’×”: ×× ××™×Ÿ ××¤×™×§ × ×‘×—×¨ â†’ 100%; ××—×¨×ª ×××•×¦×¢ ×¤×©×•×˜ ×©×œ ××©×§×œ (×‘×¡×§×œ×ª ××—×•×–×™× â†’ × ×¦×™×’ ×›×©×‘×¨)
  function displayWeightFromAggCell(cell, hasCategoryFilter) {
    if (!cell) return null;
    if (!hasCategoryFilter) return 1.0; // 100%
    if (!cell.n) return null;
    const avgWeightPct = cell.wSumPct / cell.n;      // ×‘×¡×§×œ×ª ××—×•×–×™×
    return avgWeightPct / 100;                       // ×œ×©×‘×¨ ×œ×ª×¦×•×’×”
  }

  // ×“×™×¨×•×’ DENSE ×™×•×¨×“
  function denseRankDesc(rankMap) {
    const entries = Object.entries(rankMap).filter(([,v])=>v!==null && v!==undefined && !isNaN(v));
    const total = entries.length;
    if (!total) return {};
    entries.sort((a,b)=> b[1] - a[1]);
    const out = {};
    let rank = 0, lastVal = null;
    entries.forEach(([k,v])=>{
      if (lastVal===null || v < lastVal - 1e-12) { rank = rank + 1; lastVal = v; }
      out[k] = `${rank}/${total}`;
    });
    return out;
  }

  // ×ª×©×•××” ××¦×˜×‘×¨×ª ×œ×›×œ ×”×ª×§×•×¤×” (××›×¤×œ×ª (1+×ª×©×•××”) ×¢×œ ×¤× ×™ ×”×©× ×™× ×©× ××¦××•×ª ×‘×˜×•×•×—)
  function cumulativeReturnForEntity(entityYearsData, visibleYears) {
    const ylds = [];
    for (const y of visibleYears) {
      const cell = entityYearsData[y];
      if (!cell || cell.yieldFrac===null || isNaN(cell.yieldFrac)) return null;
      ylds.push(cell.yieldFrac);
    }
    if (!ylds.length) return null;
    if (ylds.length===1) return ylds[0];
    let prod = 1;
    ylds.forEach(v=> prod *= (1+v));
    return prod - 1;
  }

  /* ===========================
     ×‘× ×™×™×ª ××˜×¨×™×¦×ª ×“×™×¨×•×’/×©×™×¢×•×¨/×ª×©×•××”
  ============================ */
  function yearsInScope(rows) { return uniqueSortedYears(rows); }
  function renderYearsBadges(containerId, rows) {
    const el = document.getElementById(containerId);
    const yrs = yearsInScope(rows);
    el.innerHTML = yrs.length ? yrs.map(y=>`<span class="year-chip">${y}</span>`).join("") : "â€”";
  }

  function buildMatrix(rows, { byTracks=false } = {}) {
    const scopeYears = yearsInScope(rows);
    const hasCategory = (getCurrentFilters().category || []).length > 0;

    const entityKeyFn = byTracks
      ? (r)=> (r.company_short||r.company||"×œ× ×™×“×•×¢") + "||" + (r.track_name || (r.track_id ? "××¡×œ×•×œ "+r.track_id : ""))
      : (r)=> (r.company_short||r.company||"×œ× ×™×“×•×¢");

    const entityLabel = (k)=> {
      const [comp,track] = k.split("||");
      return byTracks ? { company:comp, track:(track||"") } : { company:comp };
    };

    // ×¦×‘×™×¨×” ×¢× ×™×—×™×“×•×ª ×‘××—×•×–×™×
    const aggs = aggregateByEntityYear(rows, entityKeyFn);

    const perEntity = {};
    for (const [key, yearsMap] of Object.entries(aggs)) {
      const yearsData = {};
      let wDispSum=0, wDispN=0;

      for (const y of scopeYears) {
        const cell = yearsMap[y];
        if (!cell) { yearsData[y] = { yieldFrac:null, wDisp:null }; continue; }

        // ×ª×©×•××”_% = ×¡×›×•×(×ª×¨×•××”_%) / ×¡×›×•×(××©×§×œ_%)
        const yieldFrac = cell.wSumPct ? (cell.cSumPct / cell.wSumPct) : null; // ×¢×“×™×™×Ÿ ×›×©×‘×¨ (0.12 = 12%)
        const wDisp = displayWeightFromAggCell(cell, hasCategory);             // ×›×©×‘×¨ (0-1)

        yearsData[y] = { yieldFrac, wDisp };
        if (wDisp!==null) { wDispSum += wDisp; wDispN += 1; }
      }

      const yieldCum = cumulativeReturnForEntity(yearsData, scopeYears);
      const wDispAvg = wDispN ? (wDispSum / wDispN) : (hasCategory ? null : 1.0);
      perEntity[key] = { years: yearsData, allPeriod: { yieldCum, wDispAvg } };
    }

    // ×“×™×¨×•×’×™×
    const rankAllWeight = {};
    const rankAllYield  = {};
    const rankPerYearWeight = {};
    const rankPerYearYield  = {};

    const mapAllWeight = {};
    const mapAllYield  = {};
    for (const [k,obj] of Object.entries(perEntity)) {
      mapAllWeight[k] = obj.allPeriod.wDispAvg;
      mapAllYield[k]  = obj.allPeriod.yieldCum;
    }
    Object.assign(rankAllWeight, denseRankDesc(mapAllWeight));
    Object.assign(rankAllYield,  denseRankDesc(mapAllYield));

    for (const y of scopeYears) {
      const mW = {};
      const mY = {};
      for (const [k,obj] of Object.entries(perEntity)) {
        mW[k] = obj.years[y].wDisp;
        mY[k] = obj.years[y].yieldFrac;
      }
      rankPerYearWeight[y] = denseRankDesc(mW);
      rankPerYearYield[y]  = denseRankDesc(mY);
    }

    return { scopeYears, perEntity, rankAllWeight, rankAllYield, rankPerYearWeight, rankPerYearYield, entityLabel };
  }

  function renderMatrixHeader({ includeTrack=false, scopeYears }) {
    const colsStatic = includeTrack ? 2 : 1;
    let thead = `<thead>`;

    thead += `<tr class="th-group">`;
    thead += `<th colspan="${colsStatic}">×™×©×•×ª</th>`;
    thead += `<th colspan="4">×›×œ ×”×ª×§×•×¤×”</th>`;
    scopeYears.forEach(y => { thead += `<th colspan="4">${y}</th>`; });
    thead += `</tr>`;

    thead += `<tr>`;
    thead += `<th>×—×‘×¨×”</th>`;
    if (includeTrack) thead += `<th>××¡×œ×•×œ</th>`;
    thead += `<th>×“×™×¨×•×’ ××—×–×§×”</th><th>×“×™×¨×•×’ ×ª×©×•××”</th><th>×©×™×¢×•×¨ (%)</th><th>×ª×©×•××” (%)</th>`;
    scopeYears.forEach(()=> {
      thead += `<th>×“×™×¨×•×’ ××—×–×§×”</th><th>×“×™×¨×•×’ ×ª×©×•××”</th><th>×©×™×¢×•×¨ (%)</th><th>×ª×©×•××” (%)</th>`;
    });
    thead += `</tr>`;

    thead += `</thead>`;
    return thead;
  }

  function renderMatrixRow(key, data, rankings, includeTrack) {
    const { label, years, allP } = data;
    const { rankAllWeight, rankAllYield, rankPerYearWeight, rankPerYearYield } = rankings;

    let tr = `<tr>`;
    tr += `<td>${label.company}</td>`;
    if (includeTrack) tr += `<td>${label.track||""}</td>`;

    const rwAll = rankAllWeight[key] || "";
    const ryAll = rankAllYield[key]  || "";
    tr += `<td>${rwAll}</td>`;
    tr += `<td>${ryAll}</td>`;
    tr += `<td>${(allP.wDispAvg!==null && !isNaN(allP.wDispAvg)) ? (allP.wDispAvg*100).toFixed(2)+"%" : ""}</td>`;
    tr += `<td>${(allP.yieldCum!==null && !isNaN(allP.yieldCum)) ? (allP.yieldCum*100).toFixed(2)+"%" : ""}</td>`;

    years.order.forEach(y=>{
      const cell = years.map[y];
      const rW = rankPerYearWeight[y] && rankPerYearWeight[y][key] ? rankPerYearWeight[y][key] : "";
      const rY = rankPerYearYield[y]  && rankPerYearYield[y][key]  ? rankPerYearYield[y][key]  : "";
      const w = (cell && cell.wDisp!==null && !isNaN(cell.wDisp)) ? (cell.wDisp*100).toFixed(2)+"%" : "";
      const v = (cell && cell.yieldFrac!==null && !isNaN(cell.yieldFrac)) ? (cell.yieldFrac*100).toFixed(2)+"%" : "";
      tr += `<td>${rW}</td><td>${rY}</td><td>${w}</td><td>${v}</td>`;
    });
    tr += `</tr>`;
    return tr;
  }

  function renderMatrix(wrapperId, { byTracks=false } = {}) {
    const wrapper = document.getElementById(wrapperId);
    const rows = state.filtered || [];
    const yrs = yearsInScope(rows);
    const yearsBadgeId = (wrapperId==="table_overview_wrapper") ? "overview_years" : "tracks_years";
    renderYearsBadges(yearsBadgeId, rows);

    if (!rows.length || !yrs.length) {
      wrapper.innerHTML = "<div style='padding:8px;font-size:0.8rem;'>××™×Ÿ ×¨×©×•××•×ª ×œ×ª×¦×•×’×” ×œ××—×¨ ×”×¡×™× ×•×Ÿ.</div>";
      return;
    }

    const {
      scopeYears,
      perEntity,
      rankAllWeight,
      rankAllYield,
      rankPerYearWeight,
      rankPerYearYield,
      entityLabel
    } = buildMatrix(rows, { byTracks });

    const keys = Object.keys(perEntity).sort((a,b)=>{
      const la = entityLabel(a), lb = entityLabel(b);
      const c = la.company.localeCompare(lb.company,"he");
      if (c!==0) return c;
      if (byTracks) return (la.track||"").localeCompare(lb.track||"","he");
      return 0;
    });

    let html = `<table>`;
    html += renderMatrixHeader({ includeTrack: byTracks, scopeYears });
    html += `<tbody>`;
    keys.forEach(k=>{
      const ent = perEntity[k];
      const yearsObj = { order: scopeYears, map: ent.years };
      const data = { label: entityLabel(k), years: yearsObj, allP: ent.allPeriod };
      const rankings = { rankAllWeight, rankAllYield, rankPerYearWeight, rankPerYearYield };
      html += renderMatrixRow(k, data, rankings, byTracks);
    });
    html += `</tbody></table>`;
    wrapper.innerHTML = html;
  }

  /* ===========================
     ×¤×•×˜×¨×™× (×©××•×¨×™× ×œ×”×¨×—×‘×”)
  ============================ */
  function renderFooter(containerId) {
    const el = document.getElementById(containerId);
    if (!el) return;
  }

  function renderOverviewMatrix() {
    renderMatrix("table_overview_wrapper", { byTracks:false });
    renderFooter("overview_footer");
  }
  function renderTracksMatrix() {
    renderMatrix("table_tracks_wrapper", { byTracks:true });
    renderFooter("tracks_footer");
  }

  /* ===========================
     ×’×¨×¤×™× â€“ ×¢× ××™× ×¤×¨× ×¡ ×™×—×™×“×•×ª ×–×”×”
  ============================ */
  function renderCharts() {
    const rows = state.filtered || [];
    if (state.chartYield)  { state.chartYield.destroy();  state.chartYield  = null; }
    if (state.chartWeight) { state.chartWeight.destroy(); state.chartWeight = null; }
    const ctxYield  = document.getElementById("chart_yield").getContext("2d");
    const ctxWeight = document.getElementById("chart_weight").getContext("2d");
    if (!rows.length) return;

    const timeSet = new Set();
    rows.forEach(r=>{
      if (r.year==null || r.quarter==null) return;
      timeSet.add(r.year+"|"+r.quarter);
    });
    const timeKeys = Array.from(timeSet).sort((a,b)=>{
      const [ya,qa] = a.split("|").map(Number);
      const [yb,qb] = b.split("|").map(Number);
      if (ya!==yb) return ya-yb;
      return qa-qb;
    });
    if (!timeKeys.length) return;
    const labels = timeKeys.map(k=>{ const [yy,qq]=k.split("|"); return yy+" Q"+qq; });

    const hasCategory = (getCurrentFilters().category || []).length > 0;

    const seriesKey = (r)=>{
      const comp = r.company_short || r.company || "×œ× ×™×“×•×¢";
      const track = r.track_name || (r.track_id ? "××¡×œ×•×œ "+r.track_id : "");
      return track ? `${comp} â€“ ${track}` : comp;
    };

    // ×¨××©×™×ª: ×œ××¡×•×£ × ×ª×•× ×™ ×ª×ª-×§×‘×•×¦×•×ª ×›×“×™ ×œ×’×–×•×¨ ×“×’×œ×™ ×™×—×™×“×•×ª ×œ×›×œ ×¡×“×¨×”-×¨×‘×¢×•×Ÿ
    const bucketRows = {}; // key: series|timeKey -> array rows
    rows.forEach(r=>{
      if (r.year==null || r.quarter==null) return;
      const tk = r.year+"|"+r.quarter;
      const sk = seriesKey(r);
      const bkey = sk + "||" + tk;
      (bucketRows[bkey] = bucketRows[bkey] || []).push(r);
    });

    const flagsPerBucket = {};
    Object.entries(bucketRows).forEach(([bkey, subset])=>{
      flagsPerBucket[bkey] = unitFlagsForSubset(subset);
    });

    // ×›×¢×ª ×¦×‘×™×¨×” (×‘×¡×§×œ×ª ××—×•×–×™×) ×•×—×™×©×•×‘×™×
    const seriesYieldPct = {};  // ××—×•×–×™× (××¡×¤×¨×™× 0-100)
    const seriesWDispPct = {};  // ××©×§×œ ×œ×ª×¦×•×’×” â€“ ××—×•×–×™×
    const seriesKeysSet = new Set();

    Object.entries(bucketRows).forEach(([bkey, subset])=>{
      const [sk, tk] = bkey.split("||");
      seriesKeysSet.add(sk);
      const { wIsPct, cIsPct } = flagsPerBucket[bkey];

      let wSumPct=0, cSumPct=0, n=0;
      subset.forEach(r=>{
        const wPct = toPct(r.weight, wIsPct);
        const cPct = toPct(r.contribution, cIsPct);
        if (wPct!==null) wSumPct += wPct;
        if (cPct!==null) cSumPct += cPct;
        n += 1;
      });

      // ×ª×©×•××”_% = ×¡×›×•×(×ª×¨×•××”_%) / ×¡×›×•×(××©×§×œ_%)
      const yPct = wSumPct ? (cSumPct / wSumPct) * 100 : null;

      // ××©×§×œ ×œ×ª×¦×•×’×”: ×× ××™×Ÿ ××¤×™×§ â†’ 100%, ××—×¨×ª ×××•×¦×¢ ×¤×©×•×˜ ×©×œ ×”××©×§×œ (×‘××—×•×–×™×)
      const wDispPct = !hasCategory ? 100 : (n ? (wSumPct / n) : null);

      (seriesYieldPct[sk] = seriesYieldPct[sk] || {})[tk] = yPct;
      (seriesWDispPct[sk] = seriesWDispPct[sk] || {})[tk] = wDispPct;
    });

    const palette = [
      "#53d3ff","#ffb74d","#81c784","#ba68c8","#ff8a65",
      "#4db6ac","#ce93d8","#f06292","#ffd54f","#7986cb",
      "#90caf9","#a5d6a7","#ffe082","#ffab91","#b39ddb"
    ];
    const seriesKeys = Array.from(seriesKeysSet).sort((a,b)=>a.localeCompare(b,"he"));

    const datasetsYield = seriesKeys.map((name,idx)=>{
      const color = palette[idx%palette.length];
      const data = timeKeys.map(k=>{
        const v = seriesYieldPct[name] && seriesYieldPct[name][k];
        return (v===null || v===undefined || isNaN(v)) ? null : v;
      });
      return { label:name, data, type:"bar", backgroundColor:color+"cc", borderColor:color, borderWidth:1, order:1, skipNull:true };
    }).filter(ds=>ds.data.some(v=>v!==null && !isNaN(v)));

    const datasetsWeight = seriesKeys.map((name,idx)=>{
      const color = palette[idx%palette.length];
      const data = timeKeys.map(k=>{
        const v = seriesWDispPct[name] && seriesWDispPct[name][k];
        return (v===null || v===undefined || isNaN(v)) ? null : v;
      });
      return { label:name, data, type:"bar", backgroundColor:color+"cc", borderColor:color, borderWidth:1, order:1, skipNull:true };
    }).filter(ds=>ds.data.some(v=>v!==null && !isNaN(v)));

    const commonOptions = (yTitle) => ({
      responsive:true, maintainAspectRatio:false,
      interaction:{ mode:"index", intersect:false },
      plugins:{
        legend:{ position:"bottom", labels:{ color:"#e9eefb", boxWidth:10, font:{ size:10 } } },
        tooltip:{ callbacks:{ label:(ctx)=> {
          const v = ctx.parsed.y;
          if (v==null || isNaN(v)) return ctx.dataset.label||"";
          return `${ctx.dataset.label}: ${Number(v).toFixed(2)}%`;
        }}}
      },
      scales:{
        x:{ ticks:{ color:"#a6b2c9", maxRotation:0 }, grid:{ color:"rgba(255,255,255,0.06)" } },
        y:{ ticks:{ color:"#a6b2c9", callback:(val)=> Number(val).toFixed(1)+"%" }, grid:{ color:"rgba(255,255,255,0.04)" }, title:{ display:true, text:yTitle, color:"#e9eefb" } }
      },
      elements:{ bar:{ borderRadius:4, barPercentage:0.9, categoryPercentage:0.7 } }
    });

    if (datasetsYield.length) {
      state.chartYield = new Chart(ctxYield, { type:"bar", data:{ labels, datasets:datasetsYield }, options: commonOptions("×ª×©×•××” ×¨×‘×¢×•× ×™×ª (%)") });
    }
    if (datasetsWeight.length) {
      state.chartWeight = new Chart(ctxWeight, { type:"bar", data:{ labels, datasets:datasetsWeight }, options: commonOptions("××—×–×§×” ×¨×‘×¢×•× ×™×ª ×××•×¦×¢×ª ×œ×ª×¦×•×’×” (%)") });
    }
  }

  /* ===========================
     ××ª×—×•×œ
  ============================ */
  document.getElementById("btn_reload").addEventListener("click", reloadData);
  initNav();
  setView("tracks");
  reloadData();
</script>

</body>
</html>
