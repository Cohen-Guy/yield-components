<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <title>×“×©×‘×•×¨×“ ××¨×›×™×‘×™ ×ª×©×•××”</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root{
      --bg-main:#050816;--bg-panel:#101528;--bg-sidebar:#050a18;
      --accent:#5dd0ff;--text-main:#e9eefb;--text-muted:#a6b2c9;
      --border-subtle:rgba(255,255,255,0.06)
    }
    *{box-sizing:border-box}
    body{margin:0;min-height:100vh;background:radial-gradient(circle at top,#1a2344 0,#050816 55%,#02030a 100%);color:var(--text-main);font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;display:flex;justify-content:center}
    .app-shell{width:100%;max-width:1440px;min-height:100vh;display:grid;grid-template-columns:220px 1fr;background:linear-gradient(135deg,rgba(255,255,255,0.03),rgba(3,5,20,0.98));border-left:1px solid rgba(255,255,255,0.05);border-right:1px solid rgba(255,255,255,0.05)}
    .sidebar{background:radial-gradient(circle at top,#141b3d 0,#050a18 58%);border-right:1px solid rgba(255,255,255,0.08);padding:18px 14px;display:flex;flex-direction:column;gap:16px}
    .sidebar-logo{display:flex;gap:8px;padding:6px 4px 12px;border-bottom:1px solid rgba(255,255,255,0.07)}
    .sidebar-logo-icon{width:32px;height:32px;border-radius:10px;background:radial-gradient(circle at 30% 20%,#5dd0ff,#4a63ff);display:flex;align-items:center;justify-content:center}
    .sidebar-logo-text{display:flex;flex-direction:column;gap:2px}
    .sidebar-nav{display:flex;flex-direction:column;gap:4px;margin-top:6px}
    .nav-item{border-radius:999px;padding:7px 10px;font-size:.86rem;display:flex;gap:8px;color:var(--text-muted);cursor:pointer;border:1px solid transparent}
    .nav-item:hover{background:rgba(93,208,255,0.08);color:var(--text-main);border-color:rgba(93,208,255,0.4)}
    .nav-item.active{background:linear-gradient(120deg,rgba(93,208,255,0.25),rgba(116,127,255,0.25));color:#f8fbff;border-color:rgba(93,208,255,0.6)}
    .sidebar-meta{margin-top:auto;padding-top:8px;border-top:1px dashed rgba(255,255,255,0.12);font-size:.7rem;color:var(--text-muted);display:flex;flex-direction:column;gap:4px}
    .main{padding:16px 18px 18px;display:flex;flex-direction:column;gap:12px}
    .main-header{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .badge-file{font-size:.75rem;padding:3px 8px;border-radius:999px;background:rgba(0,0,0,0.35);border:1px solid rgba(255,255,255,0.16);color:var(--text-muted)}
    .btn-ghost{border-radius:999px;border:1px solid rgba(255,255,255,0.18);background:rgba(5,8,25,0.9);color:var(--text-main);padding:6px 10px;font-size:.8rem;cursor:pointer}
    .filters-bar{background:radial-gradient(circle at left,rgba(93,208,255,0.15),rgba(10,15,45,0.98));border-radius:14px;padding:10px 12px;border:1px solid rgba(93,208,255,0.35);display:flex;flex-wrap:wrap;gap:10px;align-items:flex-end}
    .field{display:flex;flex-direction:column;gap:3px;min-width:140px}
    select,button.reset{background:#050816;border-radius:10px;border:1px solid rgba(255,255,255,0.25);color:var(--text-main);font-size:.8rem;padding:5px 9px;min-height:30px}
    .panels-row{display:grid;grid-template-columns:2fr 1.8fr;gap:10px;margin:8px 0 10px}
    .panel{background:linear-gradient(135deg,rgba(14,18,40,0.98),rgba(10,12,30,0.98));border-radius:14px;padding:10px 12px;border:1px solid var(--border-subtle);box-shadow:0 14px 32px rgba(0,0,0,0.5);display:flex;flex-direction:column;gap:6px;min-height:220px}
    .panel-header{display:flex;align-items:center;justify-content:space-between;font-size:.9rem}
    .views-wrapper{margin-top:4px;display:flex;flex-direction:column;gap:10px}
    .view{display:none}.view.active{display:block}
    .table-meta{margin:6px 0;font-size:.78rem;color:var(--text-muted);display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    .year-chip{padding:2px 8px;border-radius:999px;border:1px solid rgba(255,255,255,0.18);background:rgba(0,0,0,0.25);font-size:.75rem}
    .table-wrapper{flex:1;overflow:auto;border-radius:10px;border:1px solid rgba(255,255,255,0.06);background:radial-gradient(circle at top left,rgba(93,208,255,0.12),rgba(5,7,20,0.96))}
    table{width:max-content;min-width:100%;border-collapse:collapse;font-size:.78rem}
    th,td{padding:6px;text-align:center;border-bottom:1px solid rgba(255,255,255,0.05);white-space:nowrap}
    th{background:linear-gradient(90deg,rgba(83,211,255,0.25),rgba(140,120,255,0.22));position:sticky;top:0;z-index:2}
    tr:nth-child(even){background:rgba(255,255,255,0.015)} tr:hover{background:rgba(83,211,255,0.09)}
    .status-text{font-size:.75rem;color:var(--text-muted)}
    @media (max-width:1040px){.app-shell{grid-template-columns:64px 1fr}.sidebar{display:none}.main{padding:12px}.panels-row{grid-template-columns:1fr}}
  </style>
</head>
<body>
<div class="app-shell">
  <aside class="sidebar">
    <div class="sidebar-logo">
      <div class="sidebar-logo-icon">â§‰</div>
      <div class="sidebar-logo-text">
        <div class="sidebar-logo-title">××¨×›×™×‘×™ ×ª×©×•××”</div>
        <div class="sidebar-logo-sub">Dashboard v3.4 â€¢ Matrix</div>
      </div>
    </div>
    <div class="sidebar-nav">
      <div class="nav-item active" data-view="tracks"><span class="icon">ğŸ“‹</span><span class="label">××¡×œ×•×œ×™× ×•×—×‘×¨×•×ª</span></div>
      <div class="nav-item" data-view="charts"><span class="icon">ğŸ“ˆ</span><span class="label">×’×¨×¤×™×</span></div>
    </div>
    <div class="sidebar-meta" id="sidebar_meta">
      <span><span>×—×‘×¨×•×ª:</span><span>-</span></span>
      <span><span>××¡×œ×•×œ×™×:</span><span>-</span></span>
      <span><span>×©× ×™×:</span><span>-</span></span>
      <span><span>×¡×”×´×› ×¨×©×•××•×ª:</span><span>-</span></span>
    </div>
  </aside>

  <main class="main">
    <header class="main-header">
      <div class="main-title-block">
        <div class="main-title"><span>×“×©×‘×•×¨×“ ××¨×›×™×‘×™ ×ª×©×•××”</span></div>
        <div class="main-subtitle">×˜×‘×œ×ª ××˜×¨×™×¦×” â€œ×›×œ ×”×ª×§×•×¤×”â€ + ×§×‘×•×¦×•×ª ×©× ×™× (×“×™×¨×•×’ ××—×–×§×”/×“×™×¨×•×’ ×ª×©×•××”/×©×™×¢×•×¨/×ª×©×•××”).</div>
      </div>
      <div class="main-header-actions">
        <div class="badge-file" id="badge_file">×§×•×‘×¥: -</div>
        <button class="btn-ghost" type="button" id="btn_reload">â†» ×¨×¢× ×•×Ÿ × ×ª×•× ×™×</button>
        <button class="btn-ghost" type="button" id="btn_reset_filters">ğŸ§¹ ××¤×¡ ×¤×™×œ×˜×¨×™×</button>
      </div>
    </header>

    <section class="filters-bar">
      <div class="field"><label>×—×‘×¨×”</label><select id="f_company"></select></div>
      <div class="field"><label>×¡×•×’ ×—×™×¡×›×•×Ÿ</label><select id="f_saving_type"></select></div>
      <div class="field"><label>×¡×•×’ ×§×•×¤×”</label><select id="f_fund_type"></select></div>
      <div class="field"><label>××¡×œ×•×œ</label><select id="f_track"></select></div>
      <div class="field"><label>×¡×—×™×¨×•×ª</label><select id="f_liquidity"></select></div>
      <div class="field"><label>××¤×™×§ ×”×©×§×¢×”</label><select id="f_category" multiple></select></div>
      <div class="field"><label>×©× ×ª ×“×™×•×•×—</label><select id="f_year" multiple></select></div>
    </section>

    <section class="panels-row">
      <div class="panel">
        <div class="panel-header"><div class="panel-header-title"><span class="icon">ğŸ“Š</span><span>××“×“×™ ××¤×ª×— â€“ ×¡×™×›×•×</span></div></div>
        <div class="kpi-row" id="kpi_row"></div>
      </div>
      <div class="panel">
        <div class="panel-header"><div class="panel-header-title"><span class="icon">â„¹ï¸</span><span>×¡×˜×˜×•×¡ ×¤×™×œ×˜×¨×™×</span></div></div>
        <div class="status-text" id="status_filters">×˜×•×¢×Ÿ × ×ª×•× ×™×...</div>
      </div>
    </section>

    <section class="views-wrapper">
      <section class="view" id="view_overview">
        <div class="panel">
          <div class="panel-header">
            <div class="panel-header-title"><span class="icon">ğŸ“Œ</span><span>×˜×‘×œ×ª ×¡×™×›×•× ×œ×¤×™ ××¡×œ×•×œ</span></div>
            <div class="panel-header-sub">×›×œ ×”×ª×§×•×¤×” + 2022/2023/2024 â†’ ×“×™×¨×•×’ ××—×–×§×”/×“×™×¨×•×’ ×ª×©×•××”/×©×™×¢×•×¨/×ª×©×•××”</div>
          </div>
          <div class="table-meta"><span>×©× ×™× ×‘×ª×¦×•×’×”:</span><div id="overview_years">â€”</div></div>
          <div class="table-wrapper" id="table_overview_wrapper">×˜×•×¢×Ÿ...</div>
        </div>
      </section>

      <section class="view active" id="view_tracks">
        <div class="panel">
          <div class="panel-header">
            <div class="panel-header-title"><span class="icon">ğŸ“‹</span><span>×˜×‘×œ×ª ×¡×™×›×•× ×œ×¤×™ ××¡×œ×•×œ</span></div>
            <div class="panel-header-sub">××•×ª×” ×”×™×¨×¨×›×™×” ×‘×“×™×•×§, ××¤×•×¨×§×ª ×œ××¡×œ×•×œ×™×</div>
          </div>
          <div class="table-meta"><span>×©× ×™× ×‘×ª×¦×•×’×”:</span><div id="tracks_years">â€”</div></div>
          <div class="table-wrapper" id="table_tracks_wrapper">×˜×•×¢×Ÿ...</div>
        </div>
      </section>

      <section class="view" id="view_charts">
        <div class="panel">
          <div class="panel-header"><div class="panel-header-title"><span class="icon">ğŸ“ˆ</span><span>×’×¨×¤×™× ×¨×‘×¢×•× ×™×™×</span></div></div>
          <div style="margin-bottom:6px;font-size:.78rem;color:var(--text-muted)">×˜×™×¤: ×¦××¦× ×¤×™×œ×˜×¨×™× ×›×“×™ ×©×”×’×¨×¤×™× ×™×”×™×• ×§×¨×™××™× ×™×•×ª×¨.</div>
          <div class="chart-block"><div class="chart-title">×ª×©×•××” ×¨×‘×¢×•× ×™×ª (%)</div><div class="chart-container"><canvas id="chart_yield"></canvas></div></div>
          <div class="chart-block"><div class="chart-title">××—×–×§×” ×¨×‘×¢×•× ×™×ª ×××•×¦×¢×ª ×œ×ª×¦×•×’×” (%)</div><div class="chart-container"><canvas id="chart_weight"></canvas></div></div>
        </div>
      </section>
    </section>
  </main>
</div>

<script>
/* ===========================
   ××¦×‘ ×’×œ×•×‘×œ×™
=========================== */
const state = { raw:[], filtered:[], meta:{}, currentView:"tracks", chartYield:null, chartWeight:null };

const FILTERS = {
  company:     { id:"f_company",     field:"company_short", sort:"locale" },
  saving_type: { id:"f_saving_type", field:"saving_type",   sort:"locale" },
  fund_type:   { id:"f_fund_type",   field:"fund_type",     sort:"locale" },
  track:       { id:"f_track",       field:"track_name",    sort:"locale" },
  liquidity:   { id:"f_liquidity",   field:"liquidity",     sort:"locale" },
  category:    { id:"f_category",    field:"category",      sort:"locale",  multi:true },
  year:        { id:"f_year",        field:"year",          sort:"numeric", multi:true }
};

/* ===========================
   Utilities + × ×™×¨××•×œ ×¡×›×™××”
=========================== */
// ××™×¤×•×™ ×¢××•×“×•×ª ××¤×©×¨×™ -> ××—×™×“
const FIELD_ALIASES = {
  company_short: ["company_short","company","×—×‘×¨×”","×©× ×—×‘×¨×”","Company"],
  saving_type:   ["saving_type","savingType","×¡×•×’ ×—×™×¡×›×•×Ÿ"],
  fund_type:     ["fund_type","fundType","×¡×•×’ ×§×•×¤×”"],
  track_name:    ["track_name","××¡×œ×•×œ","track","Track"],
  liquidity:     ["liquidity","×¡×—×™×¨×•×ª","Liquid","Liquidty","tradability"],
  category:      ["category","××¤×™×§","××¤×™×§ ×”×©×§×¢×”","asset_class","Category"],
  year:          ["year","×©× ×”","report_year"],
  quarter:       ["quarter","×¨×‘×¢×•×Ÿ","q","Q"],
  // ×©×œ×•×©×ª ×”××“×“×™× ×”×¢×™×§×¨×™×™×
  weight:        ["weight","weight_sum","×©×™×¢×•×¨","××—×•×– ××©×§×œ","Weight","AvgWeight","avg_weight"],
  contribution:  ["contribution","×ª×¨×•××”","Contribution","contrib"],
  yield:         ["yield","×ª×©×•××”","Return","return","ret","yield_percent"]
};

// ×”×—×–×¨×ª ×©×“×” ×œ×¤×™ ××œ×™××¡×™× (case-insensitive)
function pickField(obj, canonical){
  const aliases = FIELD_ALIASES[canonical] || [canonical];
  for (const key of aliases){
    // ×‘×“×™×§×” ×¨×’×™×©×”/×œ× ×¨×’×™×©×”
    if (key in obj) return obj[key];
    const found = Object.keys(obj).find(k=>k.toLowerCase()===String(key).toLowerCase());
    if (found) return obj[found];
  }
  return undefined;
}

// × ×™×¨××•×œ ×©×•×¨×” - ××¢×ª×™×§×” ×©×“×•×ª ××—×™×“×™× ×•××—×©×‘×ª × ×’×–×¨×•×ª
function normalizeRow(r){
  const row = {...r};

  const company_short = pickField(r,"company_short");
  const saving_type   = pickField(r,"saving_type");
  const fund_type     = pickField(r,"fund_type");
  const track_name    = pickField(r,"track_name");
  const liquidity     = pickField(r,"liquidity");
  const category      = pickField(r,"category");

  // ×©× ×” ×•×¨×‘×¢×•×Ÿ ×›××¡×¤×¨×™×
  const yearRaw    = pickField(r,"year");
  const quarterRaw = pickField(r,"quarter");
  const year    = yearRaw==null ? null : Number(yearRaw);
  const quarter = quarterRaw==null ? null : Number(quarterRaw);

  // ××“×“×™× ×‘×¡×™×¡×™×™× (×™×™×ª×›×Ÿ ×©×—×¡×¨×™×)
  const weightRaw       = pickField(r,"weight");
  const contributionRaw = pickField(r,"contribution");
  const yieldRaw        = pickField(r,"yield");

  // ××¡×¤×¨×™× ×‘×˜×•×—×™×
  const weight       = toNumOrNull(weightRaw);
  const contribution = toNumOrNull(contributionRaw);
  const yld          = toNumOrNull(yieldRaw);

  // ×—×™×©×•×‘×™ ×”×©×œ××”:
  // ×× ×—×¡×¨ ××—×“ ××ª×•×š (weight, contribution, yield) × × ×¡×” ×œ×”×©×œ×™× ××ª×•×š ×”×©× ×™×™× ×”××—×¨×™×:
  let W = weight, C = contribution, Y = yld;

  // ×× ×™×© W ×•-Y â†’ C = W*Y
  if ((W!=null) && (Y!=null) && (C==null)) C = W * Y;

  // ×× ×™×© C ×•-W>0 â†’ Y = C/W
  if ((C!=null) && (W!=null) && W!==0 && (Y==null)) Y = C / W;

  // ×× ×™×© C ×•-Y!=0 â†’ W = C/Y
  if ((C!=null) && (Y!=null) && Y!==0 && (W==null)) W = C / Y;

  //fallbacks ××ª×—×©×‘×™× ×‘×”×§×©×¨:
  // ×× ××™×Ÿ ×§×˜×’×•×¨×™×” ××¡×•× × ×ª ×‘×“×©×‘×•×¨×“ ×•× ×“×¨×©×ª "××—×–×§×” ×œ×ª×¦×•×’×”", × ×¨×¦×” ×œ×”×ª×™×™×—×¡ ×œ-100% (× ×˜×¤×œ ×‘×›×š ×‘×”××©×š ×“×¨×š displayWeight)
  // ×›××Ÿ ×¨×§ ×©×•××¨×™× ××ª ×”×¢×¨×›×™× ×”××—×•×©×‘×™× (×™×™×ª×›×Ÿ ×©×—×œ×§× ×¢×“×™×™×Ÿ null)

  return {
    company_short, saving_type, fund_type, track_name,
    liquidity, category, year, quarter,
    weight: W, contribution: C, yield: Y
  };
}

function toNumOrNull(v){
  if (v===null || v===undefined || v==="") return null;
  const n = Number(String(v).replace(/[, %]/g,""));
  return isNaN(n) ? null : n;
}

function pct(val, d=2){ return (val==null || isNaN(val)) ? "â€”" : (val*100).toFixed(d)+"%"; }
function uniqueSortedYears(rows){
  return Array.from(new Set(rows.map(r=>r.year).filter(v=>v!=null && Number(v)>=2022))).sort((a,b)=>a-b);
}

function setSelectOptions(selectEl, values, {includeAll=true, allLabel="×”×›×•×œ"}={}){
  const frag = document.createDocumentFragment();
  selectEl.innerHTML="";
  if (includeAll){
    const opt=document.createElement("option"); opt.value=""; opt.textContent=allLabel; frag.appendChild(opt);
  }
  values.forEach(v=>{
    const opt=document.createElement("option"); opt.value=String(v); opt.textContent=String(v); frag.appendChild(opt);
  });
  selectEl.appendChild(frag);
}
function setMultiSelectSelected(selectEl, values){
  const set=new Set((values||[]).map(String));
  Array.from(selectEl.options).forEach(o=>o.selected=set.has(String(o.value)));
}
function clearMultiSelect(el){ Array.from(el.options).forEach(o=>o.selected=false); }
function getSelectValues(el, multi=false){
  if (!multi) return el.value || "";
  return Array.from(el.selectedOptions).map(o=>o.value).filter(v=>v!=="");
}

/* ===========================
   × ×™×•×•×˜
=========================== */
function initNav(){
  document.querySelectorAll(".nav-item").forEach(item=>{
    item.addEventListener("click",()=>setView(item.getAttribute("data-view")));
  });
}
function setView(viewName){
  state.currentView=viewName;
  document.querySelectorAll(".nav-item").forEach(el=>el.classList.toggle("active", el.getAttribute("data-view")===viewName));
  document.querySelectorAll(".view").forEach(el=>el.classList.toggle("active", el.id.replace("view_","")===viewName));
  if (viewName==="overview") renderOverviewMatrix();
  else if (viewName==="tracks") renderTracksMatrix();
  else if (viewName==="charts") renderCharts();
}

/* ===========================
   ×˜×¢×™× ×ª × ×ª×•× ×™× (×¢××™×“×•×ª ×œ×©×“×•×ª ×—×¡×¨×™×)
=========================== */
async function reloadData(){
  const tableOverview=document.getElementById("table_overview_wrapper");
  const tableTracks=document.getElementById("table_tracks_wrapper");
  const statusFilters=document.getElementById("status_filters");
  tableOverview.textContent="×˜×•×¢×Ÿ × ×ª×•× ×™×...";
  tableTracks.textContent="×˜×•×¢×Ÿ × ×ª×•× ×™×...";
  statusFilters.textContent="×˜×•×¢×Ÿ × ×ª×•× ×™×...";

  try{
    const res=await fetch("/api/data");
    if(!res.ok) throw new Error("×©×’×™××” ×‘×˜×¢×™× ×ª /api/data: "+res.status);
    const data=await res.json();

    const rowsRaw = Array.isArray(data.rows) ? data.rows : [];
    // × ×™×¨××•×œ ×›×œ ×”×©×•×¨×•×ª + ×¢××™×“×•×ª ×œ×›×œ ×¡×›×™××ª ×§×œ×˜
    const normalized = rowsRaw.map(normalizeRow);

    state.raw = normalized;
    state.meta = {
      ...(data.meta||{}),
      file: (data.meta && data.meta.file) || "-",
      companies: Array.from(new Set(normalized.map(r=>r.company_short).filter(Boolean))),
      tracks: Array.from(new Set(normalized.map(r=>r.track_name).filter(Boolean))),
      years: uniqueSortedYears(normalized),
      total_rows: normalized.length
    };

    document.getElementById("badge_file").textContent="×§×•×‘×¥: "+state.meta.file;
    updateSidebarMeta();
    buildFilters();
    refreshFilterOptions();
    applyFilters();
  }catch(e){
    console.error(e);
    const msg = "×©×’×™××” ×‘×˜×¢×™× ×ª ×”× ×ª×•× ×™×. "+(e && e.message ? e.message : "");
    tableOverview.textContent = msg;
    tableTracks.textContent   = msg;
    statusFilters.textContent = msg;
  }
}
function updateSidebarMeta(){
  const m=state.meta||{};
  document.getElementById("sidebar_meta").innerHTML=`
    <span><span>×—×‘×¨×•×ª:</span><span>${(m.companies||[]).length}</span></span>
    <span><span>××¡×œ×•×œ×™×:</span><span>${(m.tracks||[]).length}</span></span>
    <span><span>×©× ×™×:</span><span>${(m.years||[]).join(" ,")||"-"}</span></span>
    <span><span>×¡×”×´×› ×¨×©×•××•×ª:</span><span>${m.total_rows||"-"}</span></span>
  `;
}

/* ===========================
   ×¤×™×œ×˜×¨×™× + ×¡× ×›×¨×•×Ÿ ××¤×™×§×™× ×¢"×¤ ×¡×—×™×¨×•×ª
=========================== */
function buildFilters(){
  const rows = state.raw||[];
  const companies   = uniqSort(rows.map(r=>r.company_short));
  const savingTypes = uniqSort(rows.map(r=>r.saving_type));
  const fundTypes   = uniqSort(rows.map(r=>r.fund_type));
  const tracks      = uniqSort(rows.map(r=>r.track_name));
  const liquidities = uniqSort(rows.map(r=>r.liquidity));
  const categories  = uniqSort(rows.map(r=>r.category));
  const years       = uniqueSortedYears(rows);

  setSelectOptions(el(FILTERS.company.id),     companies);
  setSelectOptions(el(FILTERS.saving_type.id), savingTypes);
  setSelectOptions(el(FILTERS.fund_type.id),   fundTypes);
  setSelectOptions(el(FILTERS.track.id),       tracks);
  setSelectOptions(el(FILTERS.liquidity.id),   liquidities);
  setSelectOptions(el(FILTERS.category.id),    categories, {includeAll:false});
  setSelectOptions(el(FILTERS.year.id),        years,      {includeAll:false});

  Object.values(FILTERS).forEach(({id})=>{
    const sel = el(id); if(!sel) return;
    if (!sel.multiple) sel.value="";
    sel.addEventListener("change", onFilterChange);
  });

  el(FILTERS.liquidity.id).addEventListener("change", ()=>{
    refreshFilterOptions();
    autoSelectCategoriesByLiquidity();
    applyFilters();
  });

  el("btn_reset_filters").addEventListener("click", resetAllFilters);
}
function uniqSort(list){
  return Array.from(new Set(list.filter(Boolean))).sort((a,b)=>String(a).localeCompare(String(b),"he"));
}
function el(id){ return document.getElementById(id); }

function autoSelectCategoriesByLiquidity(){
  const liqVal = el(FILTERS.liquidity.id).value;
  const catEl  = el(FILTERS.category.id);
  if(!catEl) return;

  if(!liqVal){ clearMultiSelect(catEl); return; }

  const f = getCurrentFilters();
  const rowsForCats = filterRowsByFilters(f,"category");
  const relevant = rowsForCats.filter(r=>r.liquidity===liqVal);
  const cats = Array.from(new Set(relevant.map(r=>r.category).filter(Boolean)));
  setMultiSelectSelected(catEl, cats);
}

function filterRowsByFilters(filters, ignoreKey=null){
  const rows = state.raw||[];
  return rows.filter(r=>{
    if (ignoreKey!=="company"     && filters.company     && r.company_short !== filters.company) return false;
    if (ignoreKey!=="saving_type" && filters.saving_type && r.saving_type   !== filters.saving_type) return false;
    if (ignoreKey!=="fund_type"   && filters.fund_type   && r.fund_type     !== filters.fund_type) return false;
    if (ignoreKey!=="track"       && filters.track       && r.track_name    !== filters.track) return false;
    if (ignoreKey!=="liquidity"   && filters.liquidity   && r.liquidity     !== filters.liquidity) return false;

    if (ignoreKey!=="category" && Array.isArray(filters.category) && filters.category.length &&
        !filters.category.includes(r.category)) return false;

    if (ignoreKey!=="year" && Array.isArray(filters.year) && filters.year.length &&
        !filters.year.includes(String(r.year))) return false;

    return true;
  });
}
function refreshFilterOptions(){
  const filters=getCurrentFilters();
  Object.entries(FILTERS).forEach(([key,meta])=>{
    const sel=el(meta.id); if(!sel) return;
    const isMulti=!!meta.multi;
    const prev = isMulti ? Array.from(sel.selectedOptions).map(o=>o.value) : [sel.value];

    const rowsForKey = filterRowsByFilters(filters,key);
    let values = Array.from(new Set(rowsForKey.map(r=>r[meta.field]).filter(v=>v!=null && v!=="")));
    if (meta.sort==="numeric") values.sort((a,b)=>Number(a)-Number(b));
    else values.sort((a,b)=>String(a).localeCompare(String(b),"he"));

    setSelectOptions(sel, values, {includeAll:!isMulti});

    if (isMulti){
      const valuesStr = values.map(String);
      Array.from(sel.options).forEach(o=>{
        o.selected = prev.map(String).includes(String(o.value)) && valuesStr.includes(String(o.value));
      });
    }else{
      const pv = prev[0] || "";
      sel.value = values.map(String).includes(String(pv)) ? String(pv) : "";
    }
  });
}
function getCurrentFilters(){
  return {
    company:     getSelectValues(el(FILTERS.company.id),     false),
    saving_type: getSelectValues(el(FILTERS.saving_type.id), false),
    fund_type:   getSelectValues(el(FILTERS.fund_type.id),   false),
    track:       getSelectValues(el(FILTERS.track.id),       false),
    liquidity:   getSelectValues(el(FILTERS.liquidity.id),   false),
    category:    getSelectValues(el(FILTERS.category.id),    true),
    year:        getSelectValues(el(FILTERS.year.id),        true),
  };
}
function onFilterChange(){ refreshFilterOptions(); applyFilters(); }
function resetAllFilters(){
  Object.values(FILTERS).forEach(({id})=>{
    const e=el(id); if(!e) return;
    if (e.multiple) clearMultiSelect(e); else e.value="";
  });
  refreshFilterOptions(); applyFilters();
}

/* ===========================
   ×”×—×œ×” + ×¡×˜×˜×•×¡
=========================== */
function applyFilters(){
  const f=getCurrentFilters();
  const rows=(state.raw||[]).filter(r=>r.year==null || Number(r.year)>=2022);
  state.filtered = rows.filter(r=>{
    if (f.company && r.company_short!==f.company) return false;
    if (f.saving_type && r.saving_type!==f.saving_type) return false;
    if (f.fund_type && r.fund_type!==f.fund_type) return false;
    if (f.track && r.track_name!==f.track) return false;
    if (f.liquidity && r.liquidity!==f.liquidity) return false;
    if (Array.isArray(f.category) && f.category.length && !f.category.includes(r.category)) return false;
    if (Array.isArray(f.year) && f.year.length && !f.year.includes(String(r.year))) return false;
    return true;
  });

  updateFiltersStatus();
  renderKPIs();
  renderOverviewMatrix();
  renderTracksMatrix();
  renderCharts();
}
function updateFiltersStatus(){
  const f=getCurrentFilters();
  const n=(state.filtered||[]).length;
  const parts=[];
  if (f.company) parts.push("×—×‘×¨×”: "+f.company);
  if (f.saving_type) parts.push("×¡×•×’ ×—×™×¡×›×•×Ÿ: "+f.saving_type);
  if (f.fund_type) parts.push("×¡×•×’ ×§×•×¤×”: "+f.fund_type);
  if (f.track) parts.push("××¡×œ×•×œ: "+f.track);
  if (f.liquidity) parts.push("×¡×—×™×¨×•×ª: "+f.liquidity);
  if (Array.isArray(f.category) && f.category.length) parts.push("××¤×™×§: "+f.category.join(", "));
  if (Array.isArray(f.year) && f.year.length) parts.push("×©× ×™×: "+f.year.join(", "));
  el("status_filters").textContent=(parts.length?parts.join(" â€¢ "):"×œ×œ× ×¡×™× ×•×Ÿ â€“ ××•×¦×’×•×ª ×›×œ ×”×¨×©×•××•×ª")+` â€¢ ×¨×©×•××•×ª ×œ××—×¨ ×¡×™× ×•×Ÿ: ${n}`;
}

/* ===========================
   KPI
=========================== */
function renderKPIs(){
  const rows=state.filtered||[];
  const k=el("kpi_row");
  if(!rows.length){ k.innerHTML=`<div class="kpi-card"><div class="kpi-label">××™×Ÿ × ×ª×•× ×™×</div><div class="kpi-value">0</div></div>`; return; }
  const companies=new Set(rows.map(r=>r.company_short));
  const tracks=new Set(rows.map(r=>r.track_name));
  k.innerHTML=`
    <div class="kpi-card">
      <div class="kpi-label">×—×‘×¨×•×ª ×‘×¤×™×œ×˜×¨</div>
      <div class="kpi-value">${companies.size}</div>
      <div class="kpi-badge">××ª×•×š ${state.meta.companies?state.meta.companies.length:"-"}</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-label">××¡×œ×•×œ×™× ×‘×¤×™×œ×˜×¨</div>
      <div class="kpi-value">${tracks.size}</div>
      <div class="kpi-badge">×¡×”"×› ×¨×©×•××•×ª: ${(rows||[]).length}</div>
    </div>`;
}

/* ===========================
   ×œ×•×’×™×§×ª ×—×™×©×•×‘ ×ª×©×•××”/×©×™×¢×•×¨ ×‘×¦×“ ×œ×§×•×— ×‘×œ×‘×“
=========================== */
function yearsInScope(rows){ return uniqueSortedYears(rows); }
function renderYearsBadges(containerId, rows){
  const elc=el(containerId);
  const yrs=yearsInScope(rows);
  elc.innerHTML = yrs.length ? yrs.map(y=>`<span class="year-chip">${y}</span>`).join("") : "â€”";
}

// ×§×™×‘×•×¥ ×œ×¤×™ ×™×©×•×ª ×•×©× ×” + ×¡×›×•××™ W/C + ××•× ×” N
function aggregateByEntityYear(rows, entityKeyFn){
  const by={};
  rows.forEach(r=>{
    const key=entityKeyFn(r); if(!key) return;
    if (r.year==null) return;
    const yr=Number(r.year);

    const W = (r.weight==null ? 0 : Number(r.weight));
    const C = (r.contribution==null ? 0 : Number(r.contribution));

    by[key] = by[key] || {};
    by[key][yr] = by[key][yr] || { wSum:0, cSum:0, n:0 };
    by[key][yr].wSum += isFinite(W)?W:0;
    by[key][yr].cSum += isFinite(C)?C:0;
    by[key][yr].n += 1;
  });
  return by;
}

// ××©×§×œ ×œ×ª×¦×•×’×”: ×× ××™×Ÿ ××¤×™×§ ××¡×•× ×Ÿ â†’ 100%, ××—×¨×ª ×××•×¦×¢ ×¤×©×•×˜ ×©×œ W (×œ×¤×™ N) ×›×“×™ ×œ×™×™×¦×’ "×©×™×¢×•×¨ ×œ×ª×¦×•×’×”"
function displayWeight(avgWeightSimple, hasCategoryFilter){
  return hasCategoryFilter ? avgWeightSimple : 1.0;
}

// ×“×™×¨×•×’ DENSE ×™×•×¨×“
function denseRankDesc(map){
  const entries=Object.entries(map).filter(([,v])=>v!=null && !isNaN(v));
  const total=entries.length; if(!total) return {};
  entries.sort((a,b)=>b[1]-a[1]);
  const out={}; let rank=0,last=null;
  entries.forEach(([k,v])=>{ if(last===null || v<last-1e-12){rank+=1; last=v} out[k]=`${rank}/${total}`; });
  return out;
}

/* ===========================
   ×‘× ×™×™×ª ××˜×¨×™×¦×” (Yield ××—×•×©×‘: Î£C/Î£W)
=========================== */
function buildMatrix(rows,{byTracks=false}={}){
  const scopeYears=yearsInScope(rows);
  const hasCategory=(getCurrentFilters().category||[]).length>0;

  const entityKeyFn = byTracks
    ? (r)=>(r.company_short||"×œ× ×™×“×•×¢")+"||"+(r.track_name||"")
    : (r)=>(r.company_short||"×œ× ×™×“×•×¢");

  const entityLabel = (k)=>{
    const [comp,track]=k.split("||");
    return byTracks ? {company:comp, track:(track||"")} : {company:comp};
  };

  const aggs=aggregateByEntityYear(rows, entityKeyFn);
  const perEntity={};

  for(const [key,yearsMap] of Object.entries(aggs)){
    const yearsData={};
    let wDispSum=0,wDispN=0;
    let totalWSum=0,totalCSum=0;

    for(const y of scopeYears){
      const c=yearsMap[y];
      if(!c){ yearsData[y]={yield:null,wDisp:null}; continue; }

      const yieldY = c.wSum ? (c.cSum/c.wSum) : null;          // ×ª×©×•××” ×©× ×ª×™×ª ××”× ×ª×•× ×™× ×”×§×™×™××™×
      const avgWeightSimple = c.n ? (c.wSum/c.n) : null;       // ×××•×¦×¢ ×¤×©×•×˜
      const wDisp = (avgWeightSimple==null) ? null : displayWeight(avgWeightSimple, hasCategory);

      yearsData[y]={yield:yieldY, wDisp};
      if(wDisp!=null){ wDispSum+=wDisp; wDispN+=1; }
      totalWSum += c.wSum;
      totalCSum += c.cSum;
    }

    const yieldAll = totalWSum ? (totalCSum/totalWSum) : null; // ×ª×©×•××ª ×›×œ ×”×ª×§×•×¤×”
    const wDispAvg = wDispN ? (wDispSum/wDispN) : (hasCategory ? null : 1.0);
    perEntity[key]={ years:yearsData, allPeriod:{yieldAll, wDispAvg} };
  }

  const rankAllWeight={}, rankAllYield={}, rankPerYearWeight={}, rankPerYearYield={};
  const mapAllWeight={}, mapAllYield={};
  for(const [k,obj] of Object.entries(perEntity)){
    mapAllWeight[k]=obj.allPeriod.wDispAvg;
    mapAllYield[k]=obj.allPeriod.yieldAll;
  }
  Object.assign(rankAllWeight, denseRankDesc(mapAllWeight));
  Object.assign(rankAllYield , denseRankDesc(mapAllYield));

  for(const y of scopeYears){
    const mW={},mY={};
    for(const [k,obj] of Object.entries(perEntity)){
      mW[k]=obj.years[y].wDisp;
      mY[k]=obj.years[y].yield;
    }
    rankPerYearWeight[y]=denseRankDesc(mW);
    rankPerYearYield[y] =denseRankDesc(mY);
  }

  return { scopeYears, perEntity, rankAllWeight, rankAllYield, rankPerYearWeight, rankPerYearYield, entityLabel };
}

function renderMatrixHeader({includeTrack=false, scopeYears}){
  const colsStatic=includeTrack?2:1;
  let thead=`<thead>`;
  thead+=`<tr class="th-group"><th colspan="${colsStatic}">×™×©×•×ª</th><th colspan="4">×›×œ ×”×ª×§×•×¤×”</th>`;
  scopeYears.forEach(y=> thead+=`<th colspan="4">${y}</th>`); thead+=`</tr>`;
  thead+=`<tr><th>×—×‘×¨×”</th>${includeTrack?`<th>××¡×œ×•×œ</th>`:""}
          <th>×“×™×¨×•×’ ××—×–×§×”</th><th>×“×™×¨×•×’ ×ª×©×•××”</th><th>×©×™×¢×•×¨ (%)</th><th>×ª×©×•××” (%)</th>`;
  scopeYears.forEach(()=> thead+=`<th>×“×™×¨×•×’ ××—×–×§×”</th><th>×“×™×¨×•×’ ×ª×©×•××”</th><th>×©×™×¢×•×¨ (%)</th><th>×ª×©×•××” (%)</th>`);
  thead+=`</tr></thead>`;
  return thead;
}
function renderMatrixRow(key, data, ranks, includeTrack){
  const {label, years, allP}=data;
  const {rankAllWeight, rankAllYield, rankPerYearWeight, rankPerYearYield}=ranks;

  let tr=`<tr>`;
  tr+=`<td>${label.company||""}</td>`;
  if (includeTrack) tr+=`<td>${label.track||""}</td>`;

  const rwAll=rankAllWeight[key]||"", ryAll=rankAllYield[key]||"";
  tr+=`<td>${rwAll}</td><td>${ryAll}</td>`;
  tr+=`<td>${(allP.wDispAvg!=null&&!isNaN(allP.wDispAvg))?(allP.wDispAvg*100).toFixed(2)+"%":""}</td>`;
  tr+=`<td>${(allP.yieldAll!=null&&!isNaN(allP.yieldAll))?(allP.yieldAll*100).toFixed(2)+"%":""}</td>`;

  years.order.forEach(y=>{
    const cell=years.map[y];
    const rW=(rankPerYearWeight[y]&&rankPerYearWeight[y][key])||"";
    const rY=(rankPerYearYield[y] &&rankPerYearYield[y][key]) ||"";
    const w =(cell && cell.wDisp!=null&&!isNaN(cell.wDisp)) ? (cell.wDisp*100).toFixed(2)+"%" : "";
    const v =(cell && cell.yield!=null&&!isNaN(cell.yield)) ? (cell.yield*100).toFixed(2)+"%" : "";
    tr+=`<td>${rW}</td><td>${rY}</td><td>${w}</td><td>${v}</td>`;
  });

  tr+=`</tr>`;
  return tr;
}

function renderMatrix(wrapperId,{byTracks=false}={}){
  const wrapper=el(wrapperId);
  const rows=state.filtered||[];
  const yrs=yearsInScope(rows);
  const yearsBadgeId = (wrapperId==="table_overview_wrapper") ? "overview_years" : "tracks_years";
  renderYearsBadges(yearsBadgeId, rows);

  if(!rows.length || !yrs.length){
    wrapper.innerHTML="<div style='padding:8px;font-size:.8rem;'>××™×Ÿ ×¨×©×•××•×ª ×œ×ª×¦×•×’×” ×œ××—×¨ ×”×¡×™× ×•×Ÿ.</div>";
    return;
  }

  const {
    scopeYears, perEntity, rankAllWeight, rankAllYield, rankPerYearWeight, rankPerYearYield, entityLabel
  }=buildMatrix(rows,{byTracks});

  const keys=Object.keys(perEntity).sort((a,b)=>{
    const la=entityLabel(a), lb=entityLabel(b);
    const c=(la.company||"").localeCompare(lb.company||"","he");
    if(c!==0) return c;
    if(byTracks) return (la.track||"").localeCompare(lb.track||"","he");
    return 0;
  });

  let html=`<table>`;
  html+=renderMatrixHeader({includeTrack:byTracks, scopeYears});
  html+=`<tbody>`;
  keys.forEach(k=>{
    const ent=perEntity[k];
    const yearsObj={order:scopeYears, map:ent.years};
    const data={label:entityLabel(k), years:yearsObj, allP:ent.allPeriod};
    const ranks={rankAllWeight, rankAllYield, rankPerYearWeight, rankPerYearYield};
    html+=renderMatrixRow(k, data, ranks, byTracks);
  });
  html+=`</tbody></table>`;
  wrapper.innerHTML=html;
}

function renderOverviewMatrix(){ renderMatrix("table_overview_wrapper",{byTracks:false}); }
function renderTracksMatrix(){ renderMatrix("table_tracks_wrapper",{byTracks:true}); }

/* ===========================
   ×’×¨×¤×™× (Yield = Î£C/Î£W ×œ×¤×™ ×¡×™× ×•×Ÿ)
=========================== */
function renderCharts(){
  const rows=state.filtered||[];
  if(state.chartYield){state.chartYield.destroy();state.chartYield=null;}
  if(state.chartWeight){state.chartWeight.destroy();state.chartWeight=null;}
  const ctxYield=el("chart_yield").getContext("2d");
  const ctxWeight=el("chart_weight").getContext("2d");
  if(!rows.length) return;

  const timeSet=new Set();
  rows.forEach(r=>{ if(r.year!=null && r.quarter!=null) timeSet.add(r.year+"|"+r.quarter); });
  const timeKeys=Array.from(timeSet).sort((a,b)=>{
    const [ya,qa]=a.split("|").map(Number); const [yb,qb]=b.split("|").map(Number);
    return ya!==yb ? ya-yb : qa-qb;
  });
  if(!timeKeys.length) return;
  const labels=timeKeys.map(k=>{const [yy,qq]=k.split("|"); return yy+" Q"+qq;});

  const seriesKey=(r)=>{
    const comp=r.company_short||"×œ× ×™×“×•×¢";
    const track=r.track_name||"";
    return track?`${comp} â€“ ${track}`:comp;
  };

  const seriesYield={}, seriesWeightSum={}, seriesWeightN={};
  const categorySelected=(getCurrentFilters().category||[]).length>0;

  rows.forEach(r=>{
    if(r.year==null || r.quarter==null) return;
    const tk=r.year+"|"+r.quarter, sk=seriesKey(r);
    const W=(r.weight==null?0:Number(r.weight));
    const C=(r.contribution==null?0:Number(r.contribution));

    // Î£C/Î£W
    if(!seriesYield[sk]) seriesYield[sk]={};
    if(!seriesYield[sk][tk]) seriesYield[sk][tk]={w:0,c:0};
    seriesYield[sk][tk].w += isFinite(W)?W:0;
    seriesYield[sk][tk].c += isFinite(C)?C:0;

    // ×œ××—×–×§×” ×œ×ª×¦×•×’×”
    if(!seriesWeightSum[sk]) seriesWeightSum[sk]={};
    if(!seriesWeightSum[sk][tk]){ seriesWeightSum[sk][tk]=0; seriesWeightN[sk]=seriesWeightN[sk]||{}; seriesWeightN[sk][tk]=0; }
    seriesWeightSum[sk][tk] += isFinite(W)?W:0;
    seriesWeightN[sk][tk]   += 1;
  });

  const palette=["#53d3ff","#ffb74d","#81c784","#ba68c8","#ff8a65","#4db6ac","#ce93d8","#f06292","#ffd54f","#7986cb","#90caf9","#a5d6a7","#ffe082","#ffab91","#b39ddb"];
  const sKeys=Array.from(new Set([...Object.keys(seriesYield),...Object.keys(seriesWeightSum)])).sort((a,b)=>a.localeCompare(b,"he"));

  const datasetsYield=sKeys.map((name,idx)=>{
    const color=palette[idx%palette.length];
    const data=timeKeys.map(k=>{
      const cell=seriesYield[name]&&seriesYield[name][k];
      if(!cell || !cell.w) return null;
      return (cell.c/cell.w)*100;
    });
    return {label:name, data, type:"bar", backgroundColor:color+"cc", borderColor:color, borderWidth:1, order:1, skipNull:true};
  }).filter(ds=>ds.data.some(v=>v!=null && !isNaN(v)));

  const datasetsWeight=sKeys.map((name,idx)=>{
    const color=palette[idx%palette.length];
    const data=timeKeys.map(k=>{
      if(!categorySelected){
        const cell=seriesYield[name]&&seriesYield[name][k];
        const hasData=(cell && (cell.w>0 || cell.c!==undefined)) || (seriesWeightN[name]&&seriesWeightN[name][k]>0);
        return hasData?100:null;
      }
      const sum=seriesWeightSum[name]&&seriesWeightSum[name][k];
      const n=seriesWeightN[name]&&seriesWeightN[name][k];
      if(!n) return null;
      return (sum/n)*100;
    });
    return {label:name, data, type:"bar", backgroundColor:color+"cc", borderColor:color, borderWidth:1, order:1, skipNull:true};
  }).filter(ds=>ds.data.some(v=>v!=null && !isNaN(v)));

  const opts=(yTitle)=>({
    responsive:true, maintainAspectRatio:false, interaction:{mode:"index",intersect:false},
    plugins:{legend:{position:"bottom",labels:{color:"#e9eefb",boxWidth:10,font:{size:10}}},
      tooltip:{callbacks:{label:(ctx)=>{ const v=ctx.parsed.y; if(v==null||isNaN(v)) return ctx.dataset.label||""; return `${ctx.dataset.label}: ${Number(v).toFixed(2)}%`; }}} },
    scales:{x:{ticks:{color:"#a6b2c9"}}, y:{ticks:{color:"#a6b2c9",callback:(v)=>Number(v).toFixed(1)+"%"}, title:{display:true,text:yTitle,color:"#e9eefb"}}},
    elements:{bar:{borderRadius:4,barPercentage:0.9,categoryPercentage:0.7}}
  });

  if(datasetsYield.length){ state.chartYield=new Chart(ctxYield,{type:"bar",data:{labels,datasets:datasetsYield},options:opts("×ª×©×•××” ×¨×‘×¢×•× ×™×ª (%)")}); }
  if(datasetsWeight.length){ state.chartWeight=new Chart(ctxWeight,{type:"bar",data:{labels,datasets:datasetsWeight},options:opts("××—×–×§×” ×¨×‘×¢×•× ×™×ª ×××•×¦×¢×ª ×œ×ª×¦×•×’×” (%)")}); }
}

/* ===========================
   ××ª×—×•×œ
=========================== */
el("btn_reload").addEventListener("click", reloadData);
initNav();
setView("tracks");
reloadData();
</script>
</body>
</html>
