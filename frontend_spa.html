<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <title>×“×©×‘×•×¨×“ ××¨×›×™×‘×™ ×ª×©×•××”</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      --bg-main: #050816;
      --bg-panel: #101528;
      --bg-panel-soft: #151a32;
      --bg-sidebar: #050a18;
      --accent: #5dd0ff;
      --accent-soft: rgba(93,208,255,0.14);
      --accent-strong: #3ab4ff;
      --text-main: #e9eefb;
      --text-muted: #a6b2c9;
      --border-subtle: rgba(255,255,255,0.06);
      --danger: #ff7676;
      --success: #7ce38b;
      --warning: #ffc773;
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      min-height: 100vh;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #1a2344 0, #050816 55%, #02030a 100%);
      color: var(--text-main);
      display: flex;
      align-items: stretch;
      justify-content: center;
    }

    .app-shell {
      width: 100%;
      max-width: 1440px;
      min-height: 100vh;
      display: grid;
      grid-template-columns: 220px 1fr;
      background: linear-gradient(135deg, rgba(255,255,255,0.03), rgba(3,5,20,0.98));
      border-left: 1px solid rgba(255,255,255,0.05);
      border-right: 1px solid rgba(255,255,255,0.05);
    }

    /* Sidebar */
    .sidebar {
      background: radial-gradient(circle at top, #141b3d 0, #050a18 58%);
      border-right: 1px solid rgba(255,255,255,0.08);
      padding: 18px 14px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    .sidebar-logo { display: flex; align-items: center; gap: 8px; padding: 6px 4px 12px; border-bottom: 1px solid rgba(255,255,255,0.07); }
    .sidebar-logo-icon {
      width: 32px; height: 32px; border-radius: 10px;
      background: radial-gradient(circle at 30% 20%, #5dd0ff, #4a63ff);
      display: flex; align-items: center; justify-content: center; font-size: 1.1rem;
    }
    .sidebar-logo-text { display: flex; flex-direction: column; gap: 2px; }
    .sidebar-logo-title { font-size: 0.95rem; font-weight: 600; letter-spacing: 0.03em; }
    .sidebar-logo-sub { font-size: 0.7rem; color: var(--text-muted); }

    .sidebar-nav { display: flex; flex-direction: column; gap: 4px; margin-top: 6px; }
    .nav-item {
      border-radius: 999px; padding: 7px 10px; font-size: 0.86rem;
      display: flex; align-items: center; gap: 8px; color: var(--text-muted);
      cursor: pointer; border: 1px solid transparent;
      transition: background 0.15s, transform 0.08s, border-color 0.15s, color 0.15s;
    }
    .nav-item span.icon { font-size: 1rem; width: 18px; text-align: center; }
    .nav-item:hover { background: rgba(93,208,255,0.08); color: var(--text-main); border-color: rgba(93,208,255,0.4); transform: translateY(-1px); }
    .nav-item.active { background: linear-gradient(120deg, rgba(93,208,255,0.25), rgba(116,127,255,0.25)); color: #f8fbff; border-color: rgba(93,208,255,0.6); }

    .sidebar-meta {
      margin-top: auto; padding-top: 8px; border-top: 1px dashed rgba(255,255,255,0.12);
      font-size: 0.7rem; color: var(--text-muted); display: flex; flex-direction: column; gap: 4px;
    }
    .sidebar-meta span { display: flex; justify-content: space-between; }

    /* Main area */
    .main { padding: 16px 18px 18px; display: flex; flex-direction: column; gap: 12px; }

    .main-header { display: flex; align-items: center; justify-content: space-between; gap: 10px; padding: 6px 6px 8px; }
    .main-title-block { display: flex; flex-direction: column; gap: 2px; }
    .main-title { font-size: 1.4rem; letter-spacing: 0.02em; display: flex; align-items: center; gap: 6px; }
    .main-subtitle { font-size: 0.82rem; color: var(--text-muted); }

    .badge-file {
      font-size: 0.75rem; padding: 3px 8px; border-radius: 999px;
      background: rgba(0,0,0,0.35); border: 1px solid rgba(255,255,255,0.16); color: var(--text-muted);
    }

    .main-header-actions { display: flex; align-items: center; gap: 8px; }
    .btn-ghost {
      border-radius: 999px; border: 1px solid rgba(255,255,255,0.18);
      background: rgba(5,8,25,0.9); color: var(--text-main);
      padding: 6px 10px; font-size: 0.8rem; display: flex; align-items: center; gap: 6px;
      cursor: pointer; transition: background 0.15s, transform 0.08s, box-shadow 0.15s;
    }
    .btn-ghost:hover { background: rgba(18,25,60,0.95); box-shadow: 0 4px 12px rgba(0,0,0,0.4); transform: translateY(-1px); }

    .status-text { font-size: 0.8rem; color: var(--text-muted); }

    /* Filters bar */
    .filters-bar {
      background: radial-gradient(circle at left, rgba(93,208,255,0.15), rgba(10,15,45,0.98));
      border-radius: 14px; padding: 10px 12px; border: 1px solid rgba(93,208,255,0.35);
      display: flex; flex-wrap: wrap; gap: 10px; align-items: flex-end;
      box-shadow: 0 12px 28px rgba(0,0,0,0.55);
    }
    .field { display: flex; flex-direction: column; gap: 3px; min-width: 140px; }
    .field label { font-size: 0.78rem; color: var(--text-muted); }
    select {
      background: #050816; border-radius: 10px; border: 1px solid rgba(255,255,255,0.25);
      color: var(--text-main); font-size: 0.8rem; padding: 5px 9px; outline: none; min-height: 30px;
    }
    select:focus { border-color: var(--accent); box-shadow: 0 0 0 1px rgba(93,208,255,0.5); }

    /* MATRIX TABLE */
    .matrix-wrapper { margin-top: 10px; }
    .matrix-scroll {
      margin-top: 6px;
      max-height: 260px;
      overflow: auto;
    }
    .matrix-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.78rem;
      text-align: center;
    }
    .matrix-table th,
    .matrix-table td {
      border: 1px solid var(--border-subtle);
      padding: 4px 6px;
      white-space: nowrap;
    }
    .matrix-table thead th {
      background: radial-gradient(circle at top, rgba(93,208,255,0.18), rgba(10,12,30,0.96));
    }
    .matrix-row-header {
      text-align: right;
      font-weight: 600;
      background: rgba(255,255,255,0.02);
    }

    /* KPI panels */
    .panels-row { display: grid; grid-template-columns: 2fr 1.8fr; gap: 10px; margin-top: 8px; margin-bottom: 10px; }
    .panel {
      background: linear-gradient(135deg, rgba(14,18,40,0.98), rgba(10,12,30,0.98));
      border-radius: 14px; padding: 10px 12px; border: 1px solid var(--border-subtle);
      box-shadow: 0 14px 32px rgba(0,0,0,0.5); display: flex; flex-direction: column; gap: 6px; min-height: 200px;
    }
    .panel-header { display: flex; align-items: center; justify-content: space-between; font-size: 0.9rem; }
    .panel-header-title { display: flex; align-items: center; gap: 6px; }
    .panel-header-title span.icon { font-size: 1.1rem; }

    .kpi-row {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 8px;
      margin-top: 4px;
    }
    .kpi-card {
      background: radial-gradient(circle at top, rgba(93,208,255,0.2), rgba(10,15,40,0.95));
      border-radius: 12px;
      padding: 7px 9px;
      border: 1px solid rgba(93,208,255,0.4);
      display: flex;
      flex-direction: column;
      gap: 2px;
      font-size: 0.8rem;
    }
    .kpi-label { color: var(--text-muted); font-size: 0.75rem; }
    .kpi-value { font-size: 1rem; font-weight: 600; }
    .kpi-badge { font-size: 0.7rem; color: var(--accent); }

    /* Views */
    .views-wrapper { margin-top: 4px; display: flex; flex-direction: column; gap: 10px; }
    .view { display: none; }
    .view.active { display: block; }

    /* Chart panel */
    .chart-title {
      margin: 6px 0 4px;
      font-size: 0.9rem;
      color: var(--text-main);
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .chart-container { position: relative; width: 100%; height: 260px; }

    .chart-filters-row {
      margin-top: 6px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: flex-end;
    }

    @media (max-width: 840px) {
      .app-shell { grid-template-columns: 1fr; }
      .sidebar { display: none; }
      .main { padding: 12px; }
      .panels-row { grid-template-columns: 1fr; }
      .kpi-row { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }
  </style>
</head>

<body>
<div class="app-shell">

  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="sidebar-logo">
      <div class="sidebar-logo-icon">â§‰</div>
      <div class="sidebar-logo-text">
        <div class="sidebar-logo-title">××¨×›×™×‘×™ ×ª×©×•××”</div>
        <div class="sidebar-logo-sub">Dashboard v3.1</div>
      </div>
    </div>

    <div class="sidebar-nav">
      <div class="nav-item active" data-view="charts">
        <span class="icon">ğŸ“ˆ</span><span class="label">×’×¨×¤×™×</span>
      </div>
    </div>

    <div class="sidebar-meta" id="sidebar_meta">
      <span><span>×—×‘×¨×•×ª:</span><span>-</span></span>
      <span><span>××¡×œ×•×œ×™×:</span><span>-</span></span>
      <span><span>×©× ×™×:</span><span>-</span></span>
      <span><span>×¡×”×´×› ×¨×©×•××•×ª:</span><span>-</span></span>
    </div>
  </aside>

  <!-- MAIN -->
  <main class="main">

    <!-- HEADER -->
    <header class="main-header">
      <div class="main-title-block">
        <div class="main-title">×“×©×‘×•×¨×“ ××¨×›×™×‘×™ ×ª×©×•××”</div>
        <div class="main-subtitle">
          ×’×¨×¤×™× + ×˜×‘×œ×ª ××˜×¨×™×¦×” ×œ×¤×™ ××¡×œ×•×œ / ×©× ×” / ×¨×‘×¢×•×Ÿ
        </div>
      </div>
      <div class="main-header-actions">
        <div class="badge-file" id="badge_file">×§×•×‘×¥: -</div>
        <button class="btn-ghost" type="button" id="btn_reload">â†» ×¨×¢× ×•×Ÿ × ×ª×•× ×™×</button>
      </div>
    </header>

    <!-- FILTERS (×›×œ×œ×™×™×) -->
    <section class="filters-bar">
      <!-- ×¤×™×œ×˜×¨ "×—×‘×¨×”" ×”×•×¡×¨ -->

      <div class="field">
        <label>×¡×•×’ ×—×™×¡×›×•×Ÿ</label>
        <select id="f_saving_type"></select>
      </div>

      <div class="field">
        <label>×¡×•×’ ×§×•×¤×”</label>
        <select id="f_fund_type"></select>
      </div>

      <div class="field">
        <label>××¡×œ×•×œ</label>
        <select id="f_track"></select>
      </div>

      <div class="field">
        <label>×¡×—×™×¨×•×ª</label>
        <select id="f_liquidity"></select>
      </div>

      <div class="field">
        <label>××¤×™×§ ×”×©×§×¢×”</label>
        <select id="f_category" multiple></select>
      </div>

      <div class="field">
        <label>×©× ×ª ×“×™×•×•×—</label>
        <select id="f_year" multiple></select>
      </div>

    </section>

    <!-- MATRIX TABLE -->
    <section class="matrix-wrapper">
      <div class="panel">
        <div class="panel-header">
          <div class="panel-header-title">
            <span class="icon">ğŸ§®</span>
            <span>××˜×¨×™×¦×ª ×©×™×¢×•×¨ ××¡×š ×”×ª×™×§, ×ª×¨×•××” (Î”), ×ª×©×•××” ×•×“×™×¨×•×’×™× ×œ×¤×™ ××¡×œ×•×œ / ×©× ×” / ×¨×‘×¢×•×Ÿ</span>
          </div>
        </div>
        <div id="matrix_empty" class="status-text" style="margin-top:4px; display:none;">
          ××™×Ÿ × ×ª×•× ×™× ×œ×”×¦×’×” ×¢×‘×•×¨ ×”××¡× × ×™× ×”× ×•×›×—×™×™×.
        </div>
        <div class="matrix-scroll">
          <table id="matrix_table" class="matrix-table"></table>
        </div>
      </div>
    </section>

    <!-- KPIs -->
    <section class="panels-row">
      <div class="panel">
        <div class="panel-header">
          <div class="panel-header-title"><span class="icon">ğŸ“Š</span><span>××“×“×™ ××¤×ª×— â€“ ×¡×™×›×•×</span></div>
        </div>
        <div class="kpi-row" id="kpi_row"></div>
      </div>

      <div class="panel">
        <div class="panel-header">
          <div class="panel-header-title"><span class="icon">â„¹ï¸</span><span>×¡×˜×˜×•×¡ ×¤×™×œ×˜×¨×™×</span></div>
        </div>
        <div class="status-text" id="status_filters">×˜×•×¢×Ÿ × ×ª×•× ×™×...</div>
      </div>
    </section>

    <!-- CHARTS VIEW -->
    <section class="views-wrapper">
      <section class="view active" id="view_charts">

        <div class="panel">
          <div class="panel-header">
            <div class="panel-header-title"><span class="icon">ğŸ“ˆ</span><span>×’×¨×¤×™× ×¨×‘×¢×•× ×™×™×</span></div>
            <div class="panel-header-sub">×¦×™×¨ X (×©× ×™ ×”×’×¨×¤×™× ×”×¢×œ×™×•× ×™×): ×©× ×”+×¨×‘×¢×•×Ÿ â€¢ ×¦×™×¨ Y: ××—×•×–×™×</div>
          </div>

          <div class="chart-block">
            <div class="chart-title">×ª×©×•××” ×¨×‘×¢×•× ×™×ª (%)</div>
            <div class="chart-container">
              <canvas id="chart_yield"></canvas>
            </div>
          </div>

          <div class="chart-block">
            <div class="chart-title">××—×–×§×” ×¨×‘×¢×•× ×™×ª ×××•×¦×¢×ª ×œ×ª×¦×•×’×” (%)</div>
            <div class="chart-container">
              <canvas id="chart_weight"></canvas>
            </div>
          </div>

          <!-- ×¤×™×œ×˜×¨×™× ×¤×¨×˜×™×™× ×œ×’×¨×£ ×”××—×–×§×” ×œ×¤×™ ××¡×œ×•×œ ×•×¡×—×™×¨×•×ª -->
          <div class="chart-filters-row">
            <div class="field">
              <label>×©× ×” (×’×¨×£ ××—×–×§×” ×œ×¤×™ ××¡×œ×•×œ ×•×¡×—×™×¨×•×ª)</label>
              <select id="liq_year_filter"></select>
            </div>
            <div class="field">
              <label>×¨×‘×¢×•×Ÿ</label>
              <select id="liq_quarter_filter"></select>
            </div>
          </div>

          <div class="chart-block">
            <div class="chart-title">××—×–×§×” ×œ×¤×™ ××¡×œ×•×œ ×•×¡×—×™×¨×•×ª (%)</div>
            <div class="chart-container">
              <canvas id="chart_liquidity"></canvas>
            </div>
          </div>
        </div>

      </section>
    </section>

  </main>
</div>

<script>
/* â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
   STATE
â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” */
const state = {
  raw: [],
  filtered: [],
  meta: {},
  chartYield: null,
  chartWeight: null,
  chartLiquidity: null,
};

const FILTERS = {
  saving_type: { id: "f_saving_type", field: "saving_type",   sort: "locale" },
  fund_type:   { id: "f_fund_type",   field: "fund_type",     sort: "locale" },
  track:       { id: "f_track",       field: "track_name",    sort: "locale" },
  liquidity:   { id: "f_liquidity",   field: "liquidity",     sort: "locale" },
  category:    { id: "f_category",    field: "category",      sort: "locale",  multi: true },
  year:        { id: "f_year",        field: "year",          sort: "numeric", multi: true }
};

/* â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
   UTILITIES
â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” */
function safeNumber(v) {
  const x = Number(v);
  return isNaN(x) ? null : x;
}

function setSelectOptions(selectEl, values, { includeAll = true, allLabel = "×”×›×•×œ" } = {}) {
  const frag = document.createDocumentFragment();
  selectEl.innerHTML = "";
  if (includeAll) {
    const o = document.createElement("option");
    o.value = "";
    o.textContent = allLabel;
    frag.appendChild(o);
  }
  values.forEach(v => {
    const o = document.createElement("option");
    o.value = String(v);
    o.textContent = String(v);
    frag.appendChild(o);
  });
  selectEl.appendChild(frag);
}

function uniqueSortedYears(rows) {
  return Array.from(
    new Set(rows.map(r => r.year).filter(v => Number(v) >= 2022))
  ).sort((a,b)=>a-b);
}

function getSelectValues(sel, multi=false) {
  if (!multi) return sel.value || "";
  return Array.from(sel.selectedOptions).map(o=>o.value).filter(v=>v!=="");
}

/* â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
   NAV
â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” */
document.querySelectorAll(".nav-item").forEach(item => {
  item.addEventListener("click", () => {
    document.querySelectorAll(".nav-item").forEach(n=>n.classList.remove("active"));
    item.classList.add("active");

    document.querySelectorAll(".view").forEach(v => v.classList.remove("active"));
    const name = item.dataset.view;
    document.getElementById("view_"+name).classList.add("active");

    if (name === "charts") renderCharts();
  });
});

/* â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
   LOAD DATA
â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” */
async function reloadData() {
  document.getElementById("status_filters").textContent = "×˜×•×¢×Ÿ × ×ª×•× ×™×...";
  try {
    const res = await fetch("/api/data");
    const json = await res.json();
    state.raw = json.rows || [];
    state.meta = json.meta || {};
    document.getElementById("badge_file").textContent = "×§×•×‘×¥: " + (state.meta.file || "-");
    updateSidebarMeta();
    buildFilters();
    refreshFilterOptions();
    applyFilters();
  } catch (err) {
    console.error(err);
  }
}

function updateSidebarMeta() {
  const m = state.meta || {};
  document.getElementById("sidebar_meta").innerHTML = `
    <span><span>×—×‘×¨×•×ª:</span><span>${(m.companies||[]).length}</span></span>
    <span><span>××¡×œ×•×œ×™×:</span><span>${(m.tracks||[]).length}</span></span>
    <span><span>×©× ×™×:</span><span>${(m.years||[]).join(", ")||"-"}</span></span>
    <span><span>×¡×”×´×› ×¨×©×•××•×ª:</span><span>${m.total_rows || "-"}</span></span>
  `;
}

/* â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
   FILTERS
â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” */
function buildFilters() {
  const rows = state.raw;
  const savingTypes = Array.from(new Set(rows.map(r=>r.saving_type).filter(Boolean))).sort((a,b)=>a.localeCompare(b,"he"));
  const fundTypes   = Array.from(new Set(rows.map(r=>r.fund_type).filter(Boolean))).sort((a,b)=>a.localeCompare(b,"he"));
  const tracks      = Array.from(new Set(rows.map(r=>r.track_name).filter(Boolean))).sort((a,b)=>a.localeCompare(b,"he"));
  const liquidities = Array.from(new Set(rows.map(r=>r.liquidity).filter(Boolean))).sort((a,b)=>a.localeCompare(b,"he"));
  const categories  = Array.from(new Set(rows.map(r=>r.category).filter(Boolean))).sort((a,b)=>a.localeCompare(b,"he"));
  const years       = uniqueSortedYears(rows);

  setSelectOptions(document.getElementById(FILTERS.saving_type.id), savingTypes);
  setSelectOptions(document.getElementById(FILTERS.fund_type.id),   fundTypes);
  setSelectOptions(document.getElementById(FILTERS.track.id),       tracks);
  setSelectOptions(document.getElementById(FILTERS.liquidity.id),   liquidities);
  setSelectOptions(document.getElementById(FILTERS.category.id),    categories, { includeAll:false });
  setSelectOptions(document.getElementById(FILTERS.year.id),        years,      { includeAll:false });

  Object.values(FILTERS).forEach(({id})=>{
    const el = document.getElementById(id);
    el.addEventListener("change", onFilterChange);
  });

  // ×¤×™×œ×˜×¨×™× ×¤×¨×˜×™×™× ×œ×’×¨×£ ×”××—×–×§×” ×œ×¤×™ ××¡×œ×•×œ+×¡×—×™×¨×•×ª
  const ly = document.getElementById("liq_year_filter");
  const lq = document.getElementById("liq_quarter_filter");
  if (ly) {
    ly.addEventListener("change", () => {
      refreshLiquidityFilters();
      renderLiquidityChart();
    });
  }
  if (lq) {
    lq.addEventListener("change", () => {
      renderLiquidityChart();
    });
  }
}

function getCurrentFilters() {
  return {
    saving_type: getSelectValues(document.getElementById(FILTERS.saving_type.id)),
    fund_type:   getSelectValues(document.getElementById(FILTERS.fund_type.id)),
    track:       getSelectValues(document.getElementById(FILTERS.track.id)),
    liquidity:   getSelectValues(document.getElementById(FILTERS.liquidity.id)),
    category:    getSelectValues(document.getElementById(FILTERS.category.id), true),
    year:        getSelectValues(document.getElementById(FILTERS.year.id), true),
  };
}

function onFilterChange() {
  refreshFilterOptions();
  applyFilters();
}

function refreshFilterOptions() {
  const filters = getCurrentFilters();
  const rows = state.raw;

  Object.entries(FILTERS).forEach(([key,meta])=>{
    const sel = document.getElementById(meta.id);
    const isMulti = !!meta.multi;
    const prev = isMulti
      ? Array.from(sel.selectedOptions).map(o=>o.value)
      : [sel.value];

    const rowsForKey = rows.filter(r=>{
      if (key!=="saving_type" && filters.saving_type && r.saving_type !== filters.saving_type) return false;
      if (key!=="fund_type"   && filters.fund_type   && r.fund_type   !== filters.fund_type)   return false;
      if (key!=="track"       && filters.track       && r.track_name  !== filters.track)       return false;
      if (key!=="liquidity"   && filters.liquidity   && r.liquidity   !== filters.liquidity)   return false;

      // ×©×™× ×œ×‘: ×œ× ××¡× × ×™× ×œ×¤×™ category ×›××Ÿ ×¨×§ ×× key==="category"
      if (key!=="category" && Array.isArray(filters.category) && filters.category.length &&
          !filters.category.includes(r.category)) return false;

      if (key!=="year" && Array.isArray(filters.year) && filters.year.length &&
          !filters.year.includes(String(r.year))) return false;

      return true;
    });

    let vals = Array.from(new Set(rowsForKey.map(r=>r[meta.field]).filter(Boolean)));
    if (meta.sort==="numeric") vals.sort((a,b)=>a-b);
    else vals.sort((a,b)=>String(a).localeCompare(String(b),"he"));

    setSelectOptions(sel, vals, { includeAll:!isMulti });

    if (isMulti) {
      Array.from(sel.options).forEach(o=>{
        o.selected = prev.includes(o.value);
      });
    } else {
      const selected = prev.find(v => v !== "" && vals.includes(v)) || "";
      sel.value = selected;
    }
  });
}

/* â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
   FILTER APPLICATION
â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” */
function applyFilters() {
  const f = getCurrentFilters();
  const rows = state.raw.filter(r=>Number(r.year)>=2022);

  // ×–×”×• ×”×¡×˜ ×”××¡×•× ×Ÿ ×”×›×œ×œ×™ (×›×•×œ×œ ××¤×™×§ ×”×©×§×¢×”) â€“ ×¢×‘×•×¨ ×”×˜×‘×œ×” ×•×©× ×™ ×”×’×¨×¤×™× ×”×¢×œ×™×•× ×™×
  state.filtered = rows.filter(r=>{
    if (f.saving_type && r.saving_type !== f.saving_type) return false;
    if (f.fund_type   && r.fund_type   !== f.fund_type)   return false;
    if (f.track       && r.track_name  !== f.track)       return false;
    if (f.liquidity   && r.liquidity   !== f.liquidity)   return false;

    if (Array.isArray(f.category) && f.category.length &&
        !f.category.includes(r.category)) return false;

    if (Array.isArray(f.year) && f.year.length &&
        !f.year.includes(String(r.year))) return false;

    return true;
  });

  refreshLiquidityFilters(); // ×××œ× ××¤×©×¨×•×™×•×ª ×©× ×”/×¨×‘×¢×•×Ÿ ×œ×’×¨×£ ×”×ª×—×ª×•×Ÿ ×œ×¤×™ ×¡×˜ ×™×™×¢×•×“×™ ×œ×œ× ××¤×™×§
  updateFiltersStatus();
  renderKPIs();
  renderMatrixTable();
  renderCharts();
}

function updateFiltersStatus() {
  const f = getCurrentFilters();
  const cnt = state.filtered.length;

  const parts = [];
  if (f.saving_type) parts.push("×¡×•×’ ×—×™×¡×›×•×Ÿ: "+f.saving_type);
  if (f.fund_type)   parts.push("×¡×•×’ ×§×•×¤×”: "+f.fund_type);
  if (f.track)       parts.push("××¡×œ×•×œ: "+f.track);
  if (f.liquidity)   parts.push("×¡×—×™×¨×•×ª: "+f.liquidity);
  if (f.category.length) parts.push("××¤×™×§: "+f.category.join(", "));
  if (f.year.length)     parts.push("×©× ×™×: "+f.year.join(", "));

  document.getElementById("status_filters").textContent =
    (parts.length ? parts.join(" â€¢ ") : "×œ×œ× ×¡×™× ×•×Ÿ") +
    ` â€¢ ×¨×©×•××•×ª ×œ××—×¨ ×¡×™× ×•×Ÿ: ${cnt}`;
}

/* â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
   KPI
â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” */
function renderKPIs() {
  const rows = state.filtered;
  const kpi = document.getElementById("kpi_row");

  if (!rows.length) {
    kpi.innerHTML = `<div class="kpi-card"><div class="kpi-label">××™×Ÿ × ×ª×•× ×™×</div><div class="kpi-value">0</div></div>`;
    return;
  }

  const companies = new Set(rows.map(r=>r.company_short));
  const tracks    = new Set(rows.map(r=>r.track_name));

  kpi.innerHTML = `
    <div class="kpi-card">
      <div class="kpi-label">×—×‘×¨×•×ª ×‘×¤×™×œ×˜×¨</div>
      <div class="kpi-value">${companies.size}</div>
      <div class="kpi-badge">××ª×•×š ${(state.meta.companies||[]).length}</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-label">××¡×œ×•×œ×™× ×‘×¤×™×œ×˜×¨</div>
      <div class="kpi-value">${tracks.size}</div>
      <div class="kpi-badge">×¡×”×´×› ×¨×©×•××•×ª: ${rows.length}</div>
    </div>
  `;
}

/* â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
   MATRIX TABLE (××¡×œ×•×œ / ×©× ×” / ×¨×‘×¢×•×Ÿ + ×ª×¨×•××”Î” + ×ª×©×•××” + ×“×™×¨×•×’×™×)
â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” */
function renderMatrixTable() {
  const table = document.getElementById("matrix_table");
  const emptyEl = document.getElementById("matrix_empty");
  if (!table || !emptyEl) return;

  const rows = state.filtered.filter(r => r.track_name && r.year && r.quarter);

  if (!rows.length) {
    table.innerHTML = "";
    emptyEl.style.display = "block";
    return;
  }
  emptyEl.style.display = "none";

  // ××™×¤×•×™ ×©× ×” -> ×¨×‘×¢×•× ×™×
  const yearMap = new Map();
  rows.forEach(r => {
    const y = Number(r.year);
    const q = Number(r.quarter);
    if (!y || !q) return;
    if (!yearMap.has(y)) yearMap.set(y, new Set());
    yearMap.get(y).add(q);
  });

  const years = Array.from(yearMap.keys()).sort((a,b)=>a-b);
  years.forEach(y => {
    const qs = Array.from(yearMap.get(y)).sort((a,b)=>a-b);
    yearMap.set(y, qs);
  });

  // ×©×•×¨×•×ª = ××¡×œ×•×œ×™×
  const tracks = Array.from(new Set(rows.map(r => r.track_name))).sort(
    (a,b)=>String(a).localeCompare(String(b),"he")
  );

  // ××’×¨×’×¦×™×” ×©×œ weight ×•-contribution ×œ×›×œ ××¡×œ×•×œ/×©× ×”/×¨×‘×¢×•×Ÿ (c ×”×•× ××¦×˜×‘×¨; × ×—×©×‘ Î” ××•×œ ×¨×‘×¢×•×Ÿ ×§×•×“×)
  const agg = {};
  rows.forEach(r => {
    const track = r.track_name;
    const y = Number(r.year);
    const q = Number(r.quarter);
    const w = safeNumber(r.weight) || 0;
    const c = safeNumber(r.contribution) || 0;

    if (!agg[track]) agg[track] = {};
    if (!agg[track][y]) agg[track][y] = {};
    if (!agg[track][y][q]) agg[track][y][q] = { w: 0, c: 0 };

    agg[track][y][q].w += w;
    agg[track][y][q].c += c;
  });

  // ×—×™×©×•×‘ ×“×™×¨×•×’×™× ×œ×›×œ ×¨×‘×¢×•×Ÿ:
  // ×“×™×¨×•×’ ×ª×©×•××”: ×¨×§ ×ª×©×•××•×ª > 0 (×ª×©×•××” = c/w)
  // ×“×™×¨×•×’ ××¡×š ×”×ª×™×§: ×¨×§ ××©×§×œ > 0
  const rankReturnMap = {};
  const rankWeightMap = {};

  years.forEach(y => {
    const qs = yearMap.get(y) || [];
    if (!rankReturnMap[y]) rankReturnMap[y] = {};
    if (!rankWeightMap[y]) rankWeightMap[y] = {};

    qs.forEach(q => {
      const arrReturn = [];
      const arrWeight = [];

      tracks.forEach(track => {
        const cell = agg[track]?.[y]?.[q];
        if (!cell) return;

        if (Math.abs(cell.w) > 1e-9) {
          const yVal = cell.c / cell.w;
          if (yVal && Math.abs(yVal) > 1e-9) {
            arrReturn.push({ track, val: yVal });
          }
        }

        if (cell.w && Math.abs(cell.w) > 1e-9) {
          arrWeight.push({ track, val: cell.w });
        }
      });

      arrReturn.sort((a,b)=>b.val - a.val);
      arrWeight.sort((a,b)=>b.val - a.val);

      const totalR = arrReturn.length;
      const totalW = arrWeight.length;

      const mapR = {};
      arrReturn.forEach((item,idx)=> mapR[item.track] = { rank: idx+1, total: totalR });
      const mapW = {};
      arrWeight.forEach((item,idx)=> mapW[item.track] = { rank: idx+1, total: totalW });

      rankReturnMap[y][q] = mapR;
      rankWeightMap[y][q] = mapW;
    });
  });

  let html = "<thead>";

  // ×›×•×ª×¨×ª: ×œ×›×œ ×¨×‘×¢×•×Ÿ 5 ×¢××•×“×•×ª: ××©×§×œ, ×ª×¨×•××”Î”, ×ª×©×•××”, ×“×™×¨×•×’ ×ª×©×•××”, ×“×™×¨×•×’ ××¡×š ×”×ª×™×§
  html += '<tr><th rowspan="3">××¡×œ×•×œ</th>';
  years.forEach(y => {
    const qs = yearMap.get(y) || [];
    html += `<th colspan="${qs.length * 5}">${y}</th>`;
  });
  html += "</tr>";

  html += "<tr>";
  years.forEach(y => {
    const qs = yearMap.get(y) || [];
    qs.forEach(q => {
      html += `<th colspan="5">×¨×‘×¢×•×Ÿ ${q}</th>`;
    });
  });
  html += "</tr>";

  html += "<tr>";
  years.forEach(y => {
    const qs = yearMap.get(y) || [];
    qs.forEach(() => {
      html += "<th>×©×™×¢×•×¨ ××¡×š ×”×ª×™×§ (%)</th><th>×ª×¨×•××” (Î”) (%)</th><th>×ª×©×•××” (%)</th><th>×“×™×¨×•×’ ×ª×©×•××”</th><th>×“×™×¨×•×’ ××¡×š ×”×ª×™×§</th>";
    });
  });
  html += "</tr>";

  html += "</thead><tbody>";

  tracks.forEach(track => {
    html += `<tr><td class="matrix-row-header">${track}</td>`;
    years.forEach(y => {
      const qs = yearMap.get(y) || [];
      qs.forEach(q => {
        const cell = agg[track]?.[y]?.[q] || null;

        let wDisplay = "-";
        let cDeltaDisplay = "-";
        let yDisplay = "-";
        let rankReturnDisplay = "";
        let rankWeightDisplay = "";

        if (cell) {
          // ××©×§×œ
          if (Math.abs(cell.w) > 1e-6) {
            wDisplay = (cell.w * 100).toFixed(2) + "%";
          }

          // ×ª×¨×•××” Î”: Q1 ×œ×œ× ×©×™× ×•×™; ××—×¨×ª ×”×¤×¨×© ××•×œ ×¨×‘×¢×•×Ÿ ×§×•×“×
          let cDelta = null;
          const prevCell = agg[track]?.[y]?.[q-1] || null;
          if (q === 1) {
            cDelta = cell.c;
          } else if (prevCell) {
            cDelta = cell.c - prevCell.c;
          } else {
            cDelta = null;
          }
          if (cDelta !== null && Math.abs(cDelta) > 1e-9) {
            cDeltaDisplay = (cDelta * 100).toFixed(2) + "%";
          } else if (q === 1) {
            cDeltaDisplay = ((cell.c || 0) * 100).toFixed(2) + "%";
          } else {
            cDeltaDisplay = "-";
          }

          // ×ª×©×•××” (c/w)
          if (Math.abs(cell.w) > 1e-9) {
            const yVal = cell.c / cell.w;
            if (Math.abs(yVal) > 1e-9) {
              yDisplay = (yVal * 100).toFixed(2) + "%";
              const rInfo = rankReturnMap[y]?.[q]?.[track];
              if (rInfo && rInfo.total > 0) rankReturnDisplay = `${rInfo.rank}/${rInfo.total}`;
            }
          }

          // ×“×™×¨×•×’ ××¡×š ×”×ª×™×§
          if (cell.w && Math.abs(cell.w) > 1e-9) {
            const wInfo = rankWeightMap[y]?.[q]?.[track];
            if (wInfo && wInfo.total > 0) rankWeightDisplay = `${wInfo.rank}/${wInfo.total}`;
          }
        }

        html += `<td>${wDisplay}</td><td>${cDeltaDisplay}</td><td>${yDisplay}</td><td>${rankReturnDisplay}</td><td>${rankWeightDisplay}</td>`;
      });
    });
    html += "</tr>";
  });

  html += "</tbody>";
  table.innerHTML = html;
}

/* â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
   LIQUIDITY CHART DATA (IGNORE CATEGORY FILTER)
â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” */
function rowsForLiquidityBase() {
  // ×‘×•×—×¨ × ×ª×•× ×™× ×œ×›×œ ×”×’×¨×£ ×”×ª×—×ª×•×Ÿ *×œ×œ×* ××¤×™×§ ×”×©×§×¢×”, ××š ×¢× ×©××¨ ×”××¡× × ×™× ×”×›×œ×œ×™×™×
  const f = getCurrentFilters();
  const rows = state.raw.filter(r=>Number(r.year)>=2022);
  return rows.filter(r=>{
    if (f.saving_type && r.saving_type !== f.saving_type) return false;
    if (f.fund_type   && r.fund_type   !== f.fund_type)   return false;
    if (f.track       && r.track_name  !== f.track)       return false;
    if (f.liquidity   && r.liquidity   !== f.liquidity)   return false;

    // ××ª×¢×œ××™× ×‘××›×•×•×Ÿ ×××¤×™×§ ×”×”×©×§×¢×” (category)

    if (Array.isArray(f.year) && f.year.length &&
        !f.year.includes(String(r.year))) return false;

    return true;
  });
}

/* â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
   LIQUIDITY CHART PRIVATE FILTERS (BASED ON BASE ROWS WITHOUT CATEGORY)
â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” */
function refreshLiquidityFilters() {
  const selYear = document.getElementById("liq_year_filter");
  const selQuarter = document.getElementById("liq_quarter_filter");
  if (!selYear || !selQuarter) return;

  const rows = rowsForLiquidityBase().filter(r => r.year && r.quarter);
  if (!rows.length) {
    selYear.innerHTML = "";
    selQuarter.innerHTML = "";
    return;
  }

  const yearsArr = Array.from(new Set(rows.map(r=>Number(r.year)))).sort((a,b)=>a-b);

  const prevYear = selYear.value;
  const prevQuarter = selQuarter.value;

  const defaultYear = yearsArr[yearsArr.length - 1];

  // ××™×œ×•×™ ×©× ×™×
  selYear.innerHTML = "";
  const fragYear = document.createDocumentFragment();
  yearsArr.forEach(y=>{
    const o=document.createElement("option");
    o.value=String(y);
    o.textContent=String(y);
    fragYear.appendChild(o);
  });
  selYear.appendChild(fragYear);

  let yearToUse = defaultYear;
  if (prevYear && yearsArr.includes(Number(prevYear))) {
    yearToUse = Number(prevYear);
  }
  selYear.value = String(yearToUse);

  // ×¨×‘×¢×•× ×™× ×¢×‘×•×¨ ×”×©× ×” ×©× ×‘×—×¨×”
  const quartersArr = Array.from(new Set(
    rows.filter(r=>Number(r.year)===yearToUse).map(r=>Number(r.quarter))
  )).sort((a,b)=>a-b);

  selQuarter.innerHTML = "";
  const fragQ = document.createDocumentFragment();
  quartersArr.forEach(q=>{
    const o=document.createElement("option");
    o.value=String(q);
    o.textContent=String(q);
    fragQ.appendChild(o);
  });
  selQuarter.appendChild(fragQ);

  const defaultQuarter = quartersArr[quartersArr.length - 1];
  let quarterToUse = defaultQuarter;
  if (prevQuarter && quartersArr.includes(Number(prevQuarter))) {
    quarterToUse = Number(prevQuarter);
  }
  selQuarter.value = String(quarterToUse);
}

/* â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
   CHARTS
â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” */
function renderCharts() {
  const rows = state.filtered;

  if (state.chartYield)  { state.chartYield.destroy();  state.chartYield=null; }
  if (state.chartWeight) { state.chartWeight.destroy(); state.chartWeight=null; }
  if (!rows.length) {
    if (state.chartLiquidity) { state.chartLiquidity.destroy(); state.chartLiquidity = null; }
    return;
  }

  const timeSet = new Set();
  rows.forEach(r=>{
    if (r.year && r.quarter) timeSet.add(r.year+"|"+r.quarter);
  });

  const timeKeys = Array.from(timeSet).sort((a,b)=>{
    const [ya,qa]=a.split("|").map(Number);
    const [yb,qb]=b.split("|").map(Number);
    return ya===yb ? qa-qb : ya-yb;
  });

  const labels = timeKeys.map(k=>{
    const [y,q]=k.split("|");
    return y+" Q"+q;
  });

  const seriesKey = (r)=>{
    const c = r.company_short || "×œ× ×™×“×•×¢";
    const t = r.track_name || "";
    return t ? `${c} â€“ ${t}` : c;
  };

  const seriesYield = {};
  const seriesWeightSum = {};
  const seriesWeightN = {};
  const categorySelected = getCurrentFilters().category.length>0;

  // ××•×¡×£ ×œ×¡×“×¨×•×ª ×”×ª×©×•××” ×•×”××—×–×§×” (×¢×œ ×¡××š state.filtered â€“ ×›×•×œ×œ ××¤×™×§)
  rows.forEach(r=>{
    if (!r.year || !r.quarter) return;
    const tk = `${r.year}|${r.quarter}`;
    const sk = seriesKey(r);
    const w = safeNumber(r.weight)||0;
    const c = safeNumber(r.contribution)||0;

    if (!seriesYield[sk]) seriesYield[sk]={};
    if (!seriesYield[sk][tk]) seriesYield[sk][tk]={w:0,c:0};
    seriesYield[sk][tk].w += w;
    seriesYield[sk][tk].c += c;

    if (!seriesWeightSum[sk]) seriesWeightSum[sk]={};
    if (!seriesWeightSum[sk][tk]) {
      seriesWeightSum[sk][tk]=0;
      if (!seriesWeightN[sk]) seriesWeightN[sk]={};
      seriesWeightN[sk][tk]=0;
    }
    seriesWeightSum[sk][tk]+=w;
    seriesWeightN[sk][tk]+=1;
  });

  const palette = [
    "#53d3ff","#ffb74d","#81c784","#ba68c8","#ff8a65",
    "#4db6ac","#ce93d8","#f06292","#ffd54f","#7986cb",
    "#90caf9","#a5d6a7","#ffe082","#ffab91","#b39ddb"
  ];
  const keys = Object.keys(seriesYield).sort((a,b)=>a.localeCompare(b,"he"));

  const datasetsYield = keys.map((name,i)=>{
    const color=palette[i%palette.length];
    const data=timeKeys.map(k=>{
      const cell=seriesYield[name][k];
      if (!cell||!cell.w) return null;
      return (cell.c/cell.w)*100;
    });
    return {
      label:name,
      data,
      type:"bar",
      backgroundColor:color+"cc",
      borderColor:color,
      borderWidth:1,
      skipNull:true
    };
  });

  const datasetsWeight = keys.map((name,i)=>{
    const color=palette[i%palette.length];
    const data=timeKeys.map(k=>{
      if (!categorySelected) {
        const has = (seriesYield[name][k] && seriesYield[name][k].w>0);
        return has ? 100 : null;
      }
      const sum=seriesWeightSum[name][k];
      const n=seriesWeightN[name][k];
      if (!n) return null;
      return (sum/n)*100;
    });
    return {
      label:name,
      data,
      type:"bar",
      backgroundColor:color+"cc",
      borderColor:color,
      borderWidth:1,
      skipNull:true
    };
  });

  const ctxYield  = document.getElementById("chart_yield").getContext("2d");
  const ctxWeight = document.getElementById("chart_weight").getContext("2d");

  const opt=(title)=>({
    responsive:true,
    maintainAspectRatio:false,
    interaction:{ mode:"index", intersect:false },
    plugins:{
      legend:{ position:"bottom", labels:{ color:"#e9eefb", font:{size:11} } },
      tooltip:{ callbacks:{ label:(c)=>`${c.dataset.label}: ${c.parsed.y?.toFixed(2)||0}%` } }
    },
    scales:{
      x:{ ticks:{color:"#a6b2c9"}, grid:{color:"rgba(255,255,255,0.06)"} },
      y:{ ticks:{color:"#a6b2c9", callback:v=>v.toFixed(1)+"%"}, grid:{color:"rgba(255,255,255,0.04)"}, title:{display:true,text:title,color:"#e9eefb"} }
    }
  });

  state.chartYield = new Chart(ctxYield,{
    type:"bar",
    data:{labels,datasets:datasetsYield},
    options:opt("×ª×©×•××” ×¨×‘×¢×•× ×™×ª (%)")
  });

  state.chartWeight = new Chart(ctxWeight,{
    type:"bar",
    data:{labels,datasets:datasetsWeight},
    options:opt("××—×–×§×” ×¨×‘×¢×•× ×™×ª ×××•×¦×¢×ª (%)")
  });

  renderLiquidityChart(); // ×”×’×¨×£ ×”×ª×—×ª×•×Ÿ â€“ ××ª×‘×¡×¡ ×¢×œ rowsForLiquidityBase() ×©××ª×¢×œ× ×××¤×™×§
}

/* â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
   LIQUIDITY CHART â€“ TRACK VS LIQUID / ILLIQUID (IGNORE CATEGORY FILTER)
â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” */
function renderLiquidityChart() {
  const canvas = document.getElementById("chart_liquidity");
  if (!canvas) return;

  const ctxLiquidity = canvas.getContext("2d");

  if (state.chartLiquidity) {
    state.chartLiquidity.destroy();
    state.chartLiquidity = null;
  }

  const selYear = document.getElementById("liq_year_filter");
  const selQuarter = document.getElementById("liq_quarter_filter");
  if (!selYear || !selQuarter || !selYear.value || !selQuarter.value) return;

  const yearSel = selYear.value;
  const quarterSel = selQuarter.value;

  // ×‘×¡×™×¡ × ×ª×•× ×™× ×œ×’×¨×£ ×–×” â€“ ×‘×œ×™ ××¤×™×§ ×”×©×§×¢×”
  const baseRows = rowsForLiquidityBase();

  const rows = baseRows.filter(r =>
    String(r.year) === yearSel && String(r.quarter) === quarterSel
  );

  if (!rows.length) return;

  // X-axis = track_name
  const trackSet = new Set();
  rows.forEach(r => { if (r.track_name) trackSet.add(r.track_name); });

  const tracks = Array.from(trackSet).sort(
    (a,b)=>String(a).localeCompare(String(b),"he")
  );

  const dataLiquid = [];
  const dataIlliquid = [];

  tracks.forEach(track=>{
    let wLiquid = 0;
    let wIlliquid = 0;
    rows.forEach(r=>{
      if (r.track_name !== track) return;
      const w = safeNumber(r.weight) || 0;
      if (r.liquidity === "×¡×—×™×¨") {
        wLiquid += w;
      } else {
        wIlliquid += w;
      }
    });
    dataLiquid.push(wLiquid * 100);
    dataIlliquid.push(wIlliquid * 100);
  });

  const datasetsLiquidity = [
    {
      label: "×¡×—×™×¨",
      data: dataLiquid,
      type: "bar",
      backgroundColor: "#53d3ff",
      borderColor: "#53d3ff",
      borderWidth: 1
    },
    {
      label: "×œ× ×¡×—×™×¨",
      data: dataIlliquid,
      type: "bar",
      backgroundColor: "#ffb74d",
      borderColor: "#ffb74d",
      borderWidth: 1
    }
  ];

  const options = {
    responsive:true,
    maintainAspectRatio:false,
    interaction:{ mode:"index", intersect:false },
    plugins:{
      legend:{ position:"bottom", labels:{ color:"#e9eefb", font:{size:11} } },
      tooltip:{
        callbacks:{
          label:(c)=>`${c.dataset.label}: ${c.parsed.y?.toFixed(2)||0}%`
        }
      }
    },
    scales:{
      x:{
        ticks:{color:"#a6b2c9"},
        grid:{color:"rgba(255,255,255,0.06)"},
        title:{display:true,text:"××¡×œ×•×œ",color:"#e9eefb"}
      },
      y:{
        ticks:{color:"#a6b2c9", callback:v=>v.toFixed(1)+"%"},
        grid:{color:"rgba(255,255,255,0.04)"},
        title:{display:true,text:"××—×–×§×” ××”×ª×™×§ (%)",color:"#e9eefb"}
      }
    }
  };

  state.chartLiquidity = new Chart(ctxLiquidity,{
    type: "bar",
    data: { labels: tracks, datasets: datasetsLiquidity },
    options
  });
}

/* â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
   INIT
â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” */
document.getElementById("btn_reload").addEventListener("click", reloadData);

reloadData();
renderCharts();
</script>

</body>
</html>
